<script src="/scripts/scripts-common.js"></script>
<script src="/scripts/scripts-worknav.js"></script>

{% include_relative templates.html %}
{% include_relative templates-report.html %}

{% include_relative listeners.html %}

<script>
//
// Programmer:    Craig Stuart Sapp <craig@ccrma.stanford.edu>
// Creation Date: Thu Mar 31 21:34:11 PDT 2016
// Last Modified: Tue Mar 28 16:03:55 PDT 2017
// Filename:      work/scripts-local.html
// Syntax:        JavaScript 1.8/ECMAScript 5
// vim:           ts=3: ft=javascript
//
// Description:   JavaScript management for display of work pages.
//

var REPORT = {};

var vrvToolkit;

var vrvOptions = {
	pageWidth: 2500,
	adjustPageHeight: 1,
	pageHeight: 1000,
	nonLinearSpacing: 0.65,
	spacingSystem: 5,
	spacingStaff: 5,
	font: "Leipzig",
	scale: 40
};

var CURRENT_PAGE = 1;
var INCIPIT_STYLE = 0;
var ORIGINAL_CLEFS = 0;
var INCLUDE_TEXT = 1;
var PART_FILTER = 0;


//////////////////////////////
//
// setupVariables -- Used with CGI parameter k to set default style for 
//   notation on page.
//

function setupVariables(string) {
	for (var i=0; i<string.length; i++) {
		var value = string.charAt(i);
		switch (value) {

			case 'e':
				INCIPIT_STYLE = !INCIPIT_STYLE;
				break;

			case 'o':
				ORIGINAL_CLEFS = !ORIGINAL_CLEFS;
				break;

			case 't':
				INCLUDE_TEXT = !INCLUDE_TEXT;
				break;

			case '1':
				PART_FILTER = 1;
				break;

			case '2':
				PART_FILTER = 2;
				break;

			case '3':
				PART_FILTER = 3;
				break;

			case '4':
				PART_FILTER = 4;
				break;

			case '5':
				PART_FILTER = 5;
				break;

			case '6':
				PART_FILTER = 6;
				break;

			case '7':
				PART_FILTER = 7;
				break;

			case '8':
				PART_FILTER = 8;
				break;

			case '9':
				PART_FILTER = 9;
				break;

			case '0':
				PART_FILTER = 0;
				break;

		}
	}

}



//////////////////////////////
//
// loadWorkList --
//

function loadWorkList(url) {
	if (!url) {
		url = "{{site.worklist}}";
	}
	var counter = 0;

	if (sessionStorage.RIMESETTINGLIST) {
		RIMESETTINGLIST = JSON.parse(sessionStorage.RIMESETTINGLIST);
		counter++;
	}

	if (sessionStorage.WORKLIST) {
		WORKLIST = JSON.parse(sessionStorage.WORKLIST);
		buildNextPreviousLists();
		counter++;
	}

	if (!sessionStorage.RIMESETTINGLIST) {
		var request = new XMLHttpRequest();
		request.open("GET", "{{site.rime_settings}}");
		request.addEventListener("load", function() {
			var aton = new ATON;
			RIMESETTINGLIST = aton.parse(this.responseText).RIME_SETTING;
			sessionStorage.RIMESETTINGLIST = JSON.stringify(RIMESETTINGLIST);
			counter++;
			if (counter == 2) {
				continueSetup();
				counter++;
			}
		});
		request.send();
	}

	if (!sessionStorage.WORKLIST) {
		var request = new XMLHttpRequest();
		request.open("GET", url);
		request.addEventListener("load", function() {
			WORKLIST = JSON.parse(this.responseText);
			buildNextPreviousLists();
			sessionStorage.WORKLIST = this.responseText;
			counter++;
			if (counter == 2) {
				continueSetup();
				counter++;
			}
		});
		request.send();
	}

	if (counter == 2) {
		continueSetup();
		counter++;
	}
}



//////////////////////////////
//
// continueSetup --
//

function continueSetup() {
	if (ID) {
		displaySingleWork(ID)
	} else {
		displayWorkList();
	}
}



//////////////////////////////
//
// displayWorkList --
//

function displayWorkList(target) {
	if (!target) {
		target = "#contents";
	}
	var element = document.querySelector(target);
	if (!element) {
		return;
	}
	var tsource = document.querySelector("#worklist-template").textContent;
	var workTemplate = Handlebars.compile(tsource);
	var output = workTemplate(WORKLIST[0]);
	element.innerHTML = output;
}



//////////////////////////////
//
// displaySingleWork --
//

function displaySingleWork(id, target) {
	if (!id) {
		id = ID;
	}
	ID = id;

	var element = document.querySelector("#contents");
	if (!element) {
		console.log("Error: no #contents");
		return;
	}

	workinfo = getWorkInfo(id);
	if (!workinfo) {
		console.log("Error: no workinfo: ", id);
		return;
	}
	if (!target) {
		target = "#contents";
	}
	var setting = GetSettingEntry(id);
	var work = GetWorkEntry(id);
	setting.ih = work.ih;
	setting.TITLE = work.title;
	var tsource = document.querySelector("#singlework-template").textContent;
	var singleTemplate = Handlebars.compile(tsource);
	var output = singleTemplate(setting);
	element.innerHTML = output;
	CURRENT_PAGE = 1;

	getHumdrum(id);
	getRange(id);
	getCriticalNotes(id);
}



///////////////////////////////
//
// getCriticalNotes --
//

function getCriticalNotes(id) {
	var tag = "report_" + id;
	var tagcontent;
	var element = document.querySelector("#" + tag);
	var output = "";

	if (REPORT[id]) {
		if (element) {
			output += REPORT[id];
			element.innerHTML = addCatalogLinks(output);
		}
	} else {
		var url = "{{site.critical_reports}}/" + id + "-report.html";
		var request = new XMLHttpRequest();
		request.open('GET', url);
		request.addEventListener("load", function() {
			if (this.status == 200) {
				var data = this.responseText;
				var template = Handlebars.compile(data);
				data = template(data);
				REPORT[id] = data;
				if (element) {
					// element.innerHTML = addCatalogLinks(data);
					// catalog links now done differently:
					element.innerHTML = data;
				}
			}
		});
		request.send()
	}

	getCriticalReportNoRecurse(ORDER[id].next);
	getCriticalReportNoRecurse(ORDER[id].previous);
}



//////////////////////////////
//
// addCatalogLinks --
//

function addCatalogLinks(text) {
	var re = /(Trm\d\d\d\d[a-z]+)/g;
	return text.replace(re, function(match, id) {
		if (id) {
			return "<a href='/work?id=" + id + "'>" + id + "</a>";
		}
	});
}



//////////////////////////////
//
// getCriticalReportNoRecurse --
//

function getCriticalReportNoRecurse(id) {
	var tag = "report_" + id;
	if (REPORT[id]) {
		return;
	}

	var url = "/include/report/" + id + "-report.html";
	var request = new XMLHttpRequest();
	request.open('GET', url);
	request.addEventListener("load", function() {
		if (this.status == 200) {
			var data = this.responseText;
			REPORT[id] = data;
		}
	});
	request.send()
}



//////////////////////////////
//
// initializeVerovioNotation --
//

function initializeVerovioNotation(sourceid, targetid) {
	if (!targetid) {
		targetid = "verovio-display";
	}
	if (!sourceid) {
		sourceid = "humdrum-data";
	}

	var target = document.querySelector("#" + targetid);
	if (!target) {
		console.log("Cannot find target id:", targetid);
		return;
	}

	var source = document.querySelector("#" + sourceid);
	if (!source) {
		console.log("Cannot find source id:", sourceid);
		return;
	}
	var content = source.textContent;
	var matches;

	if (matches = content.match(/^(\*\*.*)/m)) {
		var tokens = matches[1].split("\t");
		var kcount = 0;
		var tcount = 0;
		for (var i=0; i<tokens.length; i++) {
			if (tokens[i] === "**kern") {
				kcount++;
			} else if (tokens[i] === "**text") {
				tcount++;
			}
		}
	}

	if (PART_FILTER) {
		var kval = kcount - PART_FILTER + 1;
		if (kval > 0) {
			content += "\n!!!filter: extract -k " + kval + "\n";
			kcount = 1;
			tcount = 1;
		}
	}
	if (!INCLUDE_TEXT) {
		content += "\n!!!filter: extract -I **text\n";
		vrvOptions.spacingStaff = 9;
	} else {
		vrvOptions.spacingStaff = 5;
	}

	if (!vrvToolkit) {
		console.log("Error: verovio toolkit not available");
		return;
	}

	vrvOptions.pageHeight = 1000;

	if (kcount > 0) {
		vrvOptions.pageHeight = 230 * kcount + 80 * tcount;
		// target.style.height = parseInt(vrvOptions.pageHeight / 3.8 + 100 ) + "px";
	}

	if (INCIPIT_STYLE) {
		// full-page display
		vrvOptions.pageHeight = 60000;
	}
	showIncipitState();

	if (ORIGINAL_CLEFS) {
		vrvOptions.appXPathQuery = "./rdg[contains(@label, 'original-clef')]";
	} else {
		vrvOptions.appXPathQuery = "./rdg[contains(@label, 'asiuahetlkj')]";
	}

	vrvToolkit.setOptions(vrvOptions);
	vrvToolkit.loadData(content);

	var pagecount = vrvToolkit.getPageCount();
	if (CURRENT_PAGE > 1) {
		if (CURRENT_PAGE > pagecount) {
			CURRENT_PAGE = 1;
		}
	} else if (CURRENT_PAGE < 1) {
		CURRENT_PAGE = pagecount;
	}
	var svg = vrvToolkit.renderPage(CURRENT_PAGE);
	var matches;
	if (matches = svg.match(/height="(\d+)px"/)) {
		target.style.height = "";
	}
	target.innerHTML = svg;

}



//////////////////////////////
//
// incrementVerovioPage --
//

function incrementVerovioPage(direction) {
	CURRENT_PAGE += direction;
	var pagecount = vrvToolkit.getPageCount();
	if (CURRENT_PAGE > 1) {
		if (CURRENT_PAGE > pagecount) {
			CURRENT_PAGE = 1;
		}
	} else if (CURRENT_PAGE < 1) {
		CURRENT_PAGE = pagecount;
	}

	var target = document.querySelector("#verovio-display");
	if (!target) {
		console.log("Cannot find target id: #verovio-display");
		return;
	}

	var svg = vrvToolkit.renderPage(CURRENT_PAGE, vrvOptions);
	target.innerHTML = svg;

}




//////////////////////////////
//
// getHumdrum --
//

function getHumdrum(id) {
	var tag = "humdrum_" + id;
	var tagcontent;
	var element = document.querySelector("#humdrum-data");
	if (!element) {
		return;
	}

	if (sessionStorage[tag]) {
		element.textContent = sessionStorage[tag];
		initializeVerovioNotation("humdrum-data", "verovio-display");
	} else {
		var action = "humdrum";
		var url = "{{site.tasso_data_url}}/?a=" + action + "&id=" + id;
		var request = new XMLHttpRequest();
		request.open('GET', url);
		request.addEventListener("load", function() {
			var data = this.responseText;
			sessionStorage[tag] = data;
			if (element) {
				element.textContent = data;
				initializeVerovioNotation("humdrum-data", "verovio-display");
			}
		});
		request.send()
	}

	getHumdrumNoRecurse(ORDER[id].next);
	getHumdrumNoRecurse(ORDER[id].previous);
}



//////////////////////////////
//
// getHumdrumNoRecurse --
//

function getHumdrumNoRecurse(id) {
	var tag = "humdrum_" + id;
	if (sessionStorage[tag]) {
		return;
	}

	var action = "humdrum";
	var url = "{{site.tasso_data_url}}/?a=" + action + "&id=" + id
	var request = new XMLHttpRequest();
	request.open('GET', url);
	request.addEventListener("load", function() {
		var data = this.responseText;
		sessionStorage[tag] = data;
	});
	request.send()
}



//////////////////////////////
//
// getRange --
//

function getRange(id) {
	var tag = "range_" + id;
	var element = document.querySelector("#" + "range");
	if (!element) {
		console.log("Could not find storage element #range");
		return;
	}
	var output = "";
	output += "<h3>Vocal Ranges</h3>";

	if (sessionStorage[tag]) {
		if (element) {
			output += "<div class='indent'>";
			output += sessionStorage[tag];
			output += "</div>";
			element.innerHTML = output;
			setSvgSize();
		}
	} else {
		var action = "prange-svg";
		var url = "{{site.tasso_data_url}}/?a=" + action + "&id=" + id;
		var request = new XMLHttpRequest();
		request.open('GET', url);
		request.addEventListener("load", function() {
			var data = this.responseText;
			if (data.match(/DOCTYPE HTML/)) {
				return;
			}
			sessionStorage[tag] = data;
			if (element) {
				output += "<div class='indent'>";
				output += data;
				output += "</div>";
				element.innerHTML = output;
				setSvgSize();
			}
		});
		request.send()
	}

	getRangeNoRecurse(ORDER[id].next);
	getRangeNoRecurse(ORDER[id].previous);
}



//////////////////////////////
//
// setSvgSize --
//

function setSvgSize() {
	var svg = document.querySelector("#range svg");
	var width = svg.getAttribute("width");
	var height = svg.getAttribute("height");
	var scale = 1.6;
	width *= scale;
	height *= scale;
	svg.setAttribute("width", width);
	svg.setAttribute("height", height);
}



//////////////////////////////
//
// getRangeNoRecurse --
//

function getRangeNoRecurse(id) {
	var tag = "range_" + id;
	if (sessionStorage[tag]) {
		return;
	}

	var action = "prange-svg";
	var url = "{{site.tasso_data_url}}/?a=" + action + "&id=" + id
	var request = new XMLHttpRequest();
	request.open('GET', url);
	request.addEventListener("load", function() {
		var data = this.responseText;
		sessionStorage[tag] = data;
	});
	request.send()
}



//////////////////////////////
//
// getWorkInfo --
//

function getWorkInfo(id) {
	if (!WORKLIST) {
		return null;
	}
	var i, j;
	for (i=0; i<WORKLIST.length; i++) {
		var rep = WORKLIST[i];
		for (j=0; j<rep.works.length; j++) {
			if (rep.works[j].id === id) {
				return rep.works[j];
			}
		}
	}
}



//////////////////////////////
//
// getNextWork --
//

function getNextWork(id) {
	return id;
}



//////////////////////////////
//
// getPreviousWork --
//

function getPreviousWork(id) {
	return id;
}



//////////////////////////////
//
// sortByText --
//

function sortByText(index, selector) {
	var data = document.querySelectorAll(".data");
	var datalist = [];
	var i;
	for (i=0; i<data.length; i++) {
		datalist.push(data[i]);
	}
	datalist.sort(function(a, b) {
		var A;
		var B;
		if (selector) {
			A = a.cells[index].querySelector(selector).innerHTML;
			B = b.cells[index].querySelector(selector).innerHTML;
		} else {
			A = a.cells[index].innerHTML;
			B = b.cells[index].innerHTML;
		}
		var result = A.localeCompare(B);
		return result;
	});
	var body = document.querySelector("table.worklist tbody");
	body.innerHTML = "";
	for (i=0; i<datalist.length; i++) {
		body.appendChild(datalist[i]);
	}
}



//////////////////////////////
//
// sortByNumber --
//

function sortByNumber(index) {
	var data = document.querySelectorAll(".data");
	var datalist = [];
	var i;
	for (i=0; i<data.length; i++) {
		datalist.push(data[i]);
	}
	datalist.sort(function(a, b) {
		var A = parseInt(a.cells[index].innerHTML);
		var B = parseInt(b.cells[index].innerHTML);
		if (A < B)      { return -1 }
		else if (A > B) { return +1 }
		else            { return 0  }
	});
	var body = document.querySelector("table.worklist tbody");
	body.innerHTML = "";
	for (i=0; i<datalist.length; i++) {
		body.appendChild(datalist[i]);
	}
}



//////////////////////////////
//
// expandIncipit --
//

function expandIncipit() {
	var element = document.querySelector("#expand");
	var text = element.textContent;
	INCIPIT_STYLE = !INCIPIT_STYLE;
	showIncipitState();
	initializeVerovioNotation();
}



//////////////////////////////
//
// showIncipitState --
//

function showIncipitState() {
	var element = document.querySelector("#expand");
	var nelement = document.querySelector("#nextsys");
	var pelement = document.querySelector("#prevsys");
	if (INCIPIT_STYLE) {
		element.textContent = "contract";
		nelement.textContent = "";
		pelement.textContent = "";
	} else {
		element.textContent = "expand";
		nelement.textContent = "next system";
		pelement.textContent = "previous system";
	}
}



//////////////////////////////
//
// displayNextWork --
//
//

function displayNextWork(id) {
	if (!id) {
		id = ID;
	}
	var newid = ORDER[id].next;
	ID = newid;
	displaySingleWork(ID);
}



//////////////////////////////
//
// displayPreviousWork --
//
//

function displayPreviousWork(id) {
	if (!id) {
		id = ID;
	}
	var newid = ORDER[id].previous;
	ID = newid;
	displaySingleWork(ID);
}


//////////////////////////////
//
// showMeiData --
//

function showMeiData(event) {
	var data = vrvToolkit.getMEI(0, 1);
	var prefix = "<textarea style='spellcheck=false; width:100%; height:100%;'>";
	var postfix = "</textarea>";
	var w = window.open("about:blank", "MEI transcoding", 'width=600,height=800,resizeable,scrollabars,location=false');
	w.document.write(prefix + data + postfix);
	w.document.close();
	function checkTitle() {
		if (w.document) {
			w.document.title = "MEI transcoding";
		} else {
			setTimeout(checkTitle, 40);
		}
	}
	checkTitle();
	event.preventDefault();
}


</script>


