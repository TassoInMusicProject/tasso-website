<script src="/scripts/scripts-common.js"></script>

{% include_relative templates.html %}


<script>
// vim: ts=3

var RIMESETTINGLIST = [];

document.addEventListener("DOMContentLoaded", function() {
	HighlightNavigationBar();
	displayMusicPolicies();
});



//////////////////////////////
//
// displayMusicPolicies -- Show music editorial policy target element.
//

function displayMusicPolicies(target) {
	if (!target) {
		target = "#contents";
	}
	var element = document.querySelector(target);
	if (!element) {
		console.log("Error: cannot place Music Policy content on page.");
		return;
	}
	showTab("music-heading");
	var request = new XMLHttpRequest();
	request.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
			element.innerHTML = request.responseText;
			setupMusicBrowseCallbacks();
		}
	};
	request.open("GET", "music.html", true);
	request.send();
}



//////////////////////////////
//
// displayTextPolicies -- Show text editorial policy target element.
//

function displayTextPolicies(target) {
	if (!target) {
		target = "#contents";
	}
	var element = document.querySelector(target);
	if (!element) {
		console.log("Error: cannot place Text Policy content on page.");
		return;
	}
	showTab("text-heading");
	var request = new XMLHttpRequest();
	request.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
			element.innerHTML = request.responseText;
		}
	};
	request.open("GET", "text.html", true);
	request.send();
}



//////////////////////////////
//
// showTab --
//

function showTab(hiid) {
	var music     = document.querySelector("#music-heading");
	var text      = document.querySelector("#text-heading");

	music.className   = hiid == "music-heading"   ? "active" : "";
	text.className    = hiid == "text-heading"    ? "active" : "";

	fillMusicBrowsePage();

}



//////////////////////////////
//
// fillMusicBrowsePage --
//

function fillMusicBrowsePage() {
	var music = document.querySelector("#music-heading");
	if (!music.className.match(/active/)) {
		return;
	}

	var works = filterData(RIMESETTINGLIST);

	var count = works.length;
	var countElement = document.querySelector("#work-count");
	if (countElement) {
		if (count == 1) {
			countElement.innerHTML = count + " work";
		} else {
			countElement.innerHTML = count + " works";
		}
	}

	displayBrowseEntries(works);
}



//////////////////////////////
//
// filterData --
//

function filterData(entries) {
	if (!entries) {
		entries = RIMESETTINGLIST;
	}
	if (!entries) {
		return [];
	}
	if (!entries.length) {
		return [];
	}

	output = entries;

	var composerElement = document.querySelector("#browse-composer");
	var composer = "";
	if (composerElement) {
		composer = composerElement.value;
	}

	var titleElement = document.querySelector("#browse-title");
	var title = "";
	if (titleElement) {
		title = titleElement.value;
	}

	var locationElement = document.querySelector("#browse-location");
	var location = "";
	if (locationElement) {
		location = locationElement.value;
	}

	var yearElement = document.querySelector("#browse-year");
	var year = "";
	if (yearElement) {
		year = yearElement.value;
	}

	var publisherElement = document.querySelector("#browse-publisher");
	var publisher = "";
	if (publisherElement) {
		publisher = publisherElement.value;
	}

	var rismElement = document.querySelector("#browse-rism");
	var rism = "";
	if (rismElement) {
		rism = rismElement.value;
	}

	if (composer) {
		output = filterByField(output, "COMPOSER", composer);
	}
	if (title) {
		// change this to title? But there is the setting title as well.
		output = filterByField(output, "RIMETITLE", title);
	}
	if (location) {
		output = filterByField(output, "NORMLOC", location);
	}
	if (year) {
		output = filterByField(output, "PRINCEPSYEAR", year);
	}
	if (publisher) {
		output = filterByField(output, ["NORMPUBSHORT", "NORMPUB", "PRINCEPSPUB"], publisher);
	}
	if (rism) {
		output = filterByField(output, "PRINCEPSRISM", rism);
	}


	return output;
}



//////////////////////////////
//
// filterByField --
//

function filterByField(entries, field, value) {
	if (!entries) {
		return [];
	}
	if (entries.length == 0) {
		return [];
	}
console.log("GOT HERE QQQ");
	var output = [];
	var re = new RegExp(value, "i");
	for (var i=0; i<entries.length; i++) {
		if (field instanceof Array) {
			var found = 0;
			for (var j=0; j<field.length; j++) {
				if (!entries[i][field[j]]) {
					continue;
				}
				if (entries[i][field[j]].match(re)) {
					found = 1;
					break;
				}
			}
			if (found) {
				output.push(entries[i]);
			}
		} else {
			if (!entries[i][field]) {
				continue;
			}
			if (entries[i][field].match(re)) {
				output.push(entries[i]);
			}
		}
	}

	return output;
}



//////////////////////////////
//
// displayBrowseEntries --
//

function displayBrowseEntries(entries) {
	var element = document.querySelector("#browse-results");
	if (!element) {
		return;
	}

	var tsource = document.querySelector("#browse-template").textContent;
	var template = Handlebars.compile(tsource);
	element.innerHTML = template(entries);
}



///////////////////////////////
//
//  "DOMContentLoaded" --
//

window.addEventListener("DOMContentLoaded", function() {
	// if (sessionStorage.RIMESETTINGLIST) {
		var request = new XMLHttpRequest();
		request.open("GET", "{{site.rime_settings}}");
		request.addEventListener("load", function() {
			var aton = new ATON;
			RIMESETTINGLIST = aton.parse(this.responseText).RIME_SETTING;
			sessionStorage.RIMESETTINGLIST = JSON.stringify(RIMESETTINGLIST);
			console.log("DOWNLOADED RIMESETTING LIST");
			fillMusicBrowsePage();
		});
		request.send();
	// }
});


//////////////////////////////
//
// setupMusicBrowseCallbacks --
//

function setupMusicBrowseCallbacks() {

	var composerElement = document.querySelector("#browse-composer");
	if (composerElement) {
		composerElement.addEventListener("input", function() { 
			fillMusicBrowsePage();
		});
	}

	var titleElement = document.querySelector("#browse-title");
	if (titleElement) {
		titleElement.addEventListener("input", function() { 
			fillMusicBrowsePage();
		});
	}

	var locationElement = document.querySelector("#browse-location");
	if (locationElement) {
		locationElement.addEventListener("input", function() { 
			fillMusicBrowsePage();
		});
	}

	var yearElement = document.querySelector("#browse-year");
	if (yearElement) {
		yearElement.addEventListener("input", function() { 
			fillMusicBrowsePage();
		});
	}

	var publisherElement = document.querySelector("#browse-publisher");
	if (publisherElement) {
		publisherElement.addEventListener("input", function() { 
			fillMusicBrowsePage();
		});
	}

	var rismElement = document.querySelector("#browse-rism");
	if (rismElement) {
		rismElement.addEventListener("input", function() { 
			fillMusicBrowsePage();
		});
	}


}



</script>
