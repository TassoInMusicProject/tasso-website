<script>
// vim: ts=3

//////////////////////////////
//
// DOMContentLoaded event listener --
//

document.addEventListener("DOMContentLoaded", function() {
	vrvToolkit = new verovio.toolkit();
	HighlightNavigationBar();
	checkLocalStorage();
	loadWorkList("{{site.worklist}}");

	var search = document.querySelector("div#search input");
	search.addEventListener("keydown", function(event) {doSearch(event)});
});



//////////////////////////////
//
// doSearch --
//

function doSearch(event) {
	var sval = event.target.value;
	if (event.key == "Backspace") {
		sval = sval.slice(0, -1);
	} else if (event.key.length == 1) {
		sval += event.key
	}
	sval = sval.replace(/\s+$/, "");
	sval = sval.replace(/^\s+/, "");
	sval = sval.replace(/\s+/, " ");

	if (sval.length == 0) {
		showAllIncipits();
		return;
	}

	var slist = sval.split(/\s+/);
	console.log("SEARCH", slist);

	var tds = document.querySelectorAll("#incipit-list tr");
	var regexps = [];
	var i;
	for (i=0; i<slist.length; i++) {
		regexps[i] = new RegExp(slist[i], "i");
	}
	var count = 0;
	for (i=0; i<tds.length; i++) {
		if (isMatch(tds[i], regexps)) {
			tds[i].style.display = "block";
			count++;
		} else {
			tds[i].style.display = "none";
		}
	}
	setCount(count);
}


//////////////////////////////
//
// setCount --
//

function setCount(number)  {
	var element = document.querySelector("#count");
	var text = "";
	if (number == 0) {
		text = "no matches";
	} else if (number == 1) {
		text = "1 work";
	} else {
		text = number + " works";
	}
	element.innerHTML = text;
}



//////////////////////////////
//
// isMatch --
//

function isMatch(element, regexps) {
	for (var i=0; i<regexps.length; i++) {
		if (!element.innerHTML.match(regexps[i])) {
			return false;
		}
	}
	return true;
}



//////////////////////////////
//
// showAllIncipits --
//

function showAllIncipits() {
	var tds = document.querySelectorAll("#incipit-list tr");
	for (var i=0; i<tds.length; i++) {
		tds[i].style.display = "block";
	}
	setCount(tds.length);
}



//////////////////////////////
//
// hideAllIncipits --
//

function hideAllIncipits() {
	var tds = document.querySelectorAll("#incipit-list tr");
	for (var i=0; i<tds.length; i++) {
		tds[i].style.display = "none";
	}
	setCount(0);
}




</script>
