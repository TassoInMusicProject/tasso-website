
<script src="/scripts/scripts-common.js"></script>

{% include_relative templates.html %}

<script>
//
// Programmer:    Craig Stuart Sapp <craig@ccrma.stanford.edu>
// Creation Date: Thu Mar 24 21:40:22 PDT 2016
// Last Modified: Sun Mar 26 23:35:44 PDT 2017
// Filename:      tasso/scripts-local.html
// Web Address:   http://www.tassomusic.org/scripts-local.html
// Syntax:        JavaScript 1.8/ECMAScript 5
// vim:           ts=3: ft=javascript
//
// Description:   JavaScript management for the Tasso homepage.
//


var RWORKLIST = {};

//////////////////////////////
//
// Function called when document has finished loading:
//

document.addEventListener("DOMContentLoaded", function() {
	displayRimeList("#contents");
});



//////////////////////////////
//
// process Window keys down:
//

window.addEventListener('keydown', function(event) {
	if (event.metaKey) {
		return;
	}

	switch (event.keyCode) {

		case GKey:
			if (event.altKey) {
				sortByGenre(1);
				event.preventDefault();
			}
			break;

		case SKey:
			if (event.altKey) {
				sortByNumber(0);
				event.preventDefault();
			}
			break;

		case TKey:
			if (event.altKey) {
				sortByText(1);
				event.preventDefault();
			}
			break;

	}

});



//////////////////////////////
//
// displayRimeList -- Show the Rime list within the given
//     target element.
//

function displayRimeList(target) {
	if (!target) {
		target = "#contents";
	}
	var element = document.querySelector(target);
	if (!element) {
		console.log("Error: cannot place Rime list on page.");
		return;
	}

	var counter = 0;

	if (sessionStorage.RIMEVERSELIST) {
		RIMEVERSELIST = JSON.parse(sessionStorage.RIMEVERSELIST);
		counter++;
	}

	if (sessionStorage.WORKLIST) {
		WORKLIST = JSON.parse(sessionStorage.WORKLIST);
	   buildReverseWorklist();
		counter++;
	}

	if (!RIMEVERSELIST) {
		var request = new XMLHttpRequest();
		request.open("GET", "{{site.rime_verses}}");
		request.addEventListener("load", function() {
			var aton = new ATON;
			RIMEVERSELIST = aton.parse(this.responseText).RIME;
			sessionStorage.RIMEVERSELIST = JSON.stringify(RIMEVERSELIST);
			counter++;
			if (counter == 2) {
				continueProcessingRime(element, counter);
				counter++;
			}
		});
		request.send();
	}

	if (!WORKLIST) {
		var request = new XMLHttpRequest();
		request.open("GET", "{{site.worklist}}");
		request.addEventListener("load", function() {
			WORKLIST = JSON.parse(this.responseText);
	      buildReverseWorklist();
			sessionStorage.WORKLIST = this.responseText;
			counter++;
			if (counter == 2) {
				continueProcessingRime(element, counter);
				counter++;
			}
		});
		request.send();
	}

	if (counter == 2) {
		continueProcessingRime(element);
		counter++;
	}
}



//////////////////////////////
//
// displayAmintaList -- Show the Aminta list within the given
//     target element.
//

function displayAmintaList(target) {
	if (!target) {
		target = "#contents";
	}
	var element = document.querySelector(target);
	if (!element) {
		console.log("Error: cannot place Aminta list on page.");
		return;
	}

	var counter = 0;

	if (sessionStorage.AMINTALIST) {
		AMINTALIST = JSON.parse(sessionStorage.AMINTALIST);
		counter++;
	} else {
		var request = new XMLHttpRequest();
		request.open("GET", "/data/indexes/aminta-settings.aton");
		request.addEventListener("load", function() {
			var aton = new ATON;
			AMINTALIST = aton.parse(this.responseText).AMINTA;
			sessionStorage.AMINTALIST = JSON.stringify(AMINTALIST);
			continueProcessingAminta(element);
		});
		request.send();
	}

	if (sessionStorage.WORKLIST) {
		WORKLIST = JSON.parse(sessionStorage.WORKLIST);
	   buildReverseWorklist();
		counter++;
	} else {
		var request = new XMLHttpRequest();
		request.open("GET", "{{site.worklist}}");
		request.addEventListener("load", function() {
			WORKLIST = JSON.parse(this.responseText);
	      buildReverseWorklist();
			sessionStorage.WORKLIST = this.responseText;
			counter++;
			if (counter == 2) {
				continueProcessingRime(element);
				counter++;
			}
		});
		request.send();
	}

	if (counter == 2) {
		continueProcessingAminta(element);
		counter++;
	}
}



//////////////////////////////
//
// displayOtherList -- Show the Other list within the given
//     target element.
//

function displayOtherList(target) {
	if (!target) {
		target = "#contents";
	}
	var element = document.querySelector(target);
	if (!element) {
		console.log("Error: cannot place Other list on page.");
		return;
	}

	var counter = 0;

	if (sessionStorage.OTHERLIST) {
		OTHERLIST = JSON.parse(sessionStorage.OTHERLIST);
		continueProcessingOther(element);
	} else {
		var request = new XMLHttpRequest();
		request.open("GET", "/data/indexes/other-settings.aton");
		request.addEventListener("load", function() {
			var aton = new ATON;
			OTHERLIST = aton.parse(this.responseText).OTHER;
			sessionStorage.OTHERLIST = JSON.stringify(OTHERLIST);
			continueProcessingOther(element);
		});
		request.send();
	}

	if (sessionStorage.WORKLIST) {
		WORKLIST = JSON.parse(sessionStorage.WORKLIST);
	   buildReverseWorklist();
		counter++;
	} else {
		var request = new XMLHttpRequest();
		request.open("GET", "{{site.worklist}}");
		request.addEventListener("load", function() {
			WORKLIST = JSON.parse(this.responseText);
	      buildReverseWorklist();
			sessionStorage.WORKLIST = this.responseText;
			counter++;
			if (counter == 2) {
				continueProcessingRime(element);
				counter++;
			}
		});
		request.send();
	}

	if (counter == 2) {
		continueProcessingOther(element);
		counter++;
	}
}



//////////////////////////////
//
// displayGLList -- Show the Gerusalemme Liberata list within the given
//     target element.
//

function displayGLList(target) {
	if (!target) {
		target = "#contents";
	}
	var element = document.querySelector(target);
	if (!element) {
		console.log("Error: cannot place Gerusalemme list on page.");
		return;
	}

	var counter = 0;

	if (sessionStorage.GLLIST) {
		GLLIST = JSON.parse(sessionStorage.GLLIST);
		counter++;
	} else {
		var request = new XMLHttpRequest();
		request.open("GET", "/data/indexes/gerusalemme-settings.aton");
		request.addEventListener("load", function() {
			var aton = new ATON;
			GLLIST = aton.parse(this.responseText).GERUSALEMME;
			sessionStorage.GLLIST = JSON.stringify(GLLIST);
			continueProcessingGL(element);
		});
		request.send();
	}

	if (sessionStorage.WORKLIST) {
		WORKLIST = JSON.parse(sessionStorage.WORKLIST);
	   buildReverseWorklist();
		counter++;
	} else {
		var request = new XMLHttpRequest();
		request.open("GET", "{{site.worklist}}");
		request.addEventListener("load", function() {
			WORKLIST = JSON.parse(this.responseText);
	      buildReverseWorklist();
			sessionStorage.WORKLIST = this.responseText;
			counter++;
			if (counter == 2) {
				continueProcessingGL(element);
				counter++;
			}
		});
		request.send();
	}

	if (counter == 2) {
		continueProcessingGL(element);
		counter++;
	}
}



//////////////////////////////
//
// showTab --
//

function showTab(hiid) {
	var rime   = document.querySelector("#rime-heading");
	var gl     = document.querySelector("#gl-heading");
	var aminta = document.querySelector("#aminta-heading");
	var other  = document.querySelector("#other-heading");

	rime.className   = hiid == "rime-heading"   ? "active" : "";
	gl.className     = hiid == "gl-heading"     ? "active" : "";
	aminta.className = hiid == "aminta-heading" ? "active" : "";
	other.className  = hiid == "other-heading"  ? "active" : "";
}



//////////////////////////////
//
// continueProcessingRime --
//

function continueProcessingRime(element) {
	var tsource = document.querySelector("#rime-template")
	                      .textContent;
	var rimeTemplate = Handlebars.compile(tsource);
	element.innerHTML = rimeTemplate(RIMEVERSELIST);
	showTab("rime-heading");
}



//////////////////////////////
//
// continueProcessingGL --
//

function continueProcessingGL(element) {
	var tsource = document.querySelector("#gerusalemme-template")
	                      .textContent;
	var gerusalemmeTemplate = Handlebars.compile(tsource);
	var cantolist = makeCantoList(GLLIST);
	element.innerHTML = gerusalemmeTemplate(cantolist);
	showTab("gl-heading");
}



//////////////////////////////
//
// makeCantoList --
//

function makeCantoList(gllist) {
	var output = {};
	var data = output;
	for (var i=0; i<gllist.length; i++) {
		var key = gllist[i].CATALOGNUM.replace(/[a-z]$/, "");
		data[key] = {};
		data[key].gtitle = gllist[i].TITLE;
		data[key].canto  = gllist[i].CANTO;
		data[key].ottava = gllist[i].OTTAVA;
	}
	// Should already be sorted, but maybe sort here by Canto/Ottava
	// as stored in catalog number.
	return output;
}



/////////////////////////////
//
// makeEclogheList --
//

function makeEclogheList(elist) {
	var output = {};
	var data = output;
	for (var i=0; i<elist.length; i++) {
		var key = elist[i].CATALOGNUM.replace(/[a-z]$/, "");
		data[key] = {};
		data[key].etitle = elist[i].TITLE;
		data[key].ecloga = elist[i].ECLOGA;
		data[key].verse  = elist[i].VERSE;
	}
	// Should already be sorted, but maybe sort here by verse number.
	// as stored in catalog number.
	return output;
}



/////////////////////////////
//
// makeRinaldoList --
//

function makeRinaldoList(rlist) {
	var output = {};
	var data = output;
	for (var i=0; i<rlist.length; i++) {
		var key = rlist[i].CATALOGNUM.replace(/[a-z]$/, "");
		data[key] = {};
		data[key].rtitle = rlist[i].TITLE;
		data[key].canto  = rlist[i].CANTO;
		data[key].ottava = rlist[i].OTTAVA;
	}
	// Should already be sorted, but maybe sort here by verse number.
	// as stored in catalog number.
	return output;
}



/////////////////////////////
//
// makeLagrimeList --
//

function makeLagrimeList(lentry) {
	var llist = [lentry];
	var output = {};
	var data = output;
	for (var i=0; i<llist.length; i++) {
		var key = llist[i].CATALOGNUM.replace(/[a-z]$/, "");
		data[key] = {};
		data[key].ltitle = llist[i].TITLE;
		data[key].stanza = llist[i].STANZA;
	}
	// Should already be sorted, but maybe sort here by verse number.
	// as stored in catalog number.
	return output;
}



/////////////////////////////
//
// makeTorrisomondoList --
//

function makeTorrismondoList(lentry) {
	var llist = [lentry];
	var output = {};
	var data = output;
	for (var i=0; i<llist.length; i++) {
		var key = llist[i].CATALOGNUM.replace(/[a-z]$/, "");
		data[key] = {};
		data[key].ttitle  = llist[i].TITLE;
		data[key].act     = llist[i].ACT;
		data[key].scene   = llist[i].SCENE;
		data[key].section = llist[i].SECTION;
	}
	// Should already be sorted, but maybe sort here by verse number.
	// as stored in catalog number.
	return output;
}



//////////////////////////////
//
// makeAmintaVerseList --
//

function makeAmintaVerseList(amlist) {
	var output = {};
	var data = output;
	for (var i=0; i<amlist.length; i++) {
		var key = amlist[i].CATALOGNUM.replace(/[a-z]$/, "");
		data[key] = {};
		data[key].atitle = amlist[i].TITLE;
		data[key].act = amlist[i].ACT;
		data[key].scene = amlist[i].SCENE;
		data[key].verse = amlist[i].VERSE;
	}
	// Should already be sorted, but maybe sort here by verse number.
	// as stored in catalog number.
	return output;
}



//////////////////////////////
//
// continueProcessingAminta --
//

function continueProcessingAminta(element) {
	var tsource = document.querySelector("#aminta-template")
	                      .textContent;
	var amintaTemplate = Handlebars.compile(tsource);
	var amintalist = makeAmintaVerseList(AMINTALIST);
	element.innerHTML = amintaTemplate(amintalist);
	showTab("aminta-heading");
}



//////////////////////////////
//
// continueProcessingOther --
//

function continueProcessingOther(element) {
	var esource = document.querySelector("#ecloghe-template").textContent;
	var rsource = document.querySelector("#rinaldo-template").textContent;
	var lsource = document.querySelector("#lagrime-template").textContent;
	var tsource = document.querySelector("#torrismondo-template").textContent;

	var eclogheTemplate = Handlebars.compile(esource);
	var rinaldoTemplate = Handlebars.compile(rsource);
	var lagrimeTemplate = Handlebars.compile(lsource);
	var torrismondoTemplate = Handlebars.compile(tsource);

	var ecloghelist = makeEclogheList(OTHERLIST.ECLOGHE);
	var rinaldolist = makeRinaldoList(OTHERLIST.RINALDO);
	var lagrimelist = makeLagrimeList(OTHERLIST.LAGRIME);
	var torrismondolist = makeTorrismondoList(OTHERLIST.TORRISMONDO);

	var output = "<h2 style='margin-left:100px'>Ecloghe</h2>";
	output += eclogheTemplate(ecloghelist);
	output += "<h2 style='margin-top:-80px; margin-left:100px'>Rinaldo</h2>";
	output += rinaldoTemplate(rinaldolist);
	output += "<h2 style='margin-top:-80px; margin-left:100px'>Lagrime della Beata Vergine</h2>";
	output += lagrimeTemplate(lagrimelist);
	output += "<h2 style='margin-top:-80px; margin-left:100px'>Re Torrismondo</h2>";
	output += torrismondoTemplate(torrismondolist);
	element.innerHTML = output;
	showTab("other-heading");
}



//////////////////////////////
//
// buildReveseWorklist --
//

function buildReverseWorklist() {
	RWORKLIST = {};
	var wl = WORKLIST[0].works;
	var rime;
	for (var i in wl) {
		if (!RWORKLIST[wl[i].id]) {
		   RWORKLIST[wl[i].id] = 0;
		}
		RWORKLIST[wl[i].id] += 1;
		rime = wl[i].id.replace(/[a-z]+$/, "");
		if (!RWORKLIST[rime]) {
			RWORKLIST[rime] = 0;
		}
		RWORKLIST[rime] += 1;
	}
}



//////////////////////////////
//
// show --
//

function show(element) {
	var item = element.querySelector("table");
	item.style.visibility = "visible";
}



//////////////////////////////
//
// hide --
//

function hide(element) {
	var item = element.querySelector("table");
	item.style.visibility = "hidden";
}



//////////////////////////////
//
// sortByText --
//

function sortByText(index) {
	var data = document.querySelectorAll(".data");
	var datalist = [];
	var i;
	for (i=0; i<data.length; i++) {
		datalist.push(data[i]);
	}
	datalist.sort(function(a, b) {
		var A = a.cells[index].innerHTML;
		var B = b.cells[index].innerHTML;
		var result = A.localeCompare(B);
		return result;
	});
	var body = document.querySelector("table.poem-list tbody");
	body.innerHTML = "";
	for (i=0; i<datalist.length; i++) {
		body.appendChild(datalist[i]);
	}
}



//////////////////////////////
//
// sortByGenre --
//

function sortByGenre(index) {
	var data = document.querySelectorAll(".data");
	var datalist = [];
	var i;
	for (i=0; i<data.length; i++) {
		datalist.push(data[i]);
	}
	datalist.sort(function(a, b) {
		var A = a.cells[index].querySelector(".genre").textContent;
		var B = b.cells[index].querySelector(".genre").textContent;
		var result = A.localeCompare(B);
		return result;
	});
	var body = document.querySelector("table.poem-list tbody");
	body.innerHTML = "";
	for (i=0; i<datalist.length; i++) {
		body.appendChild(datalist[i]);
	}
}



//////////////////////////////
//
// sortByNumber --
//

function sortByNumber(index) {
	var data = document.querySelectorAll(".data");
	var datalist = [];
	var i;
	for (i=0; i<data.length; i++) {
		datalist.push(data[i]);
	}
	datalist.sort(function(a, b) {
		var A;
		var B;
		if (a.cells[index].textContent.match(/^\s*\d/)) {
			A = parseInt(a.cells[index].innerHTML);
		} else {
			return +1;
			A = a.cells[index].textContent;
		}
		if (b.cells[index].textContent.match(/^\s*\d/)) {
			B = parseInt(b.cells[index].innerHTML);
		} else {
			return -1;
			B = b.cells[index].textContent;
		}
		if (A < B)      { return -1 }
		else if (A > B) { return +1 }
		else            { return 0  }
	});
	var body = document.querySelector("table.poem-list tbody");
	body.innerHTML = "";
	for (i=0; i<datalist.length; i++) {
		body.appendChild(datalist[i]);
	}
}


</script>

