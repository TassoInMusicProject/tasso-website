
<!-- Handlebars templates for browse page.
	vim: ts=3 ft=javascript
	-->

<!-- browse-template -->

{% raw %}
<script id="browse-template" type="text/x-handlebars-template">
	<table class="browse-list">
	<thead>
		<th style="width:130px; text-align:left;">Catalog&nbsp;#</th>
		<th style="width:170px; text-align:left;">Composer</th>
		<th style="text-align:left;">Title</th>
		<th style="text-align:left;">Publication information</th>
	<thead>
	<tbody>
	{{#each this}}
		<tr style="vertical-align:top">
			<td><a href="/work?id={{CATALOGNUM}}">{{CATALOGNUM}}</a></td>
			<td>{{shortComposer COMPOSER}}</td>
			<td>{{RIMETITLE}} (<i>rime</i>&nbsp;{{SOLERTI}})</td>
			<td>{{NORMLOC}}: {{PRINCEPSPUB}}, {{PRINCEPSYEAR}}
		</tr>
	{{/each}}
	</tbody>
	</table>
</script>
{% endraw %}

<script>

//////////////////////////////
//
// shortComposer Handlebar helper  -- Prevent linebreak after RISM
//      and its number.
//

Handlebars.registerHelper("shortComposer", function(text) {
	var matches;
	text = text.replace(/^\s+/, "").replace(/\s+$/, "");
	var lastname = text;
	var firstname = text;
	var abbrname = "";
	var pieces;
	var output;
	if (!text.match(/(.*),\s+(.*)/)) {
		text = text.replace(/\.\s*/, ", ");
	}
	if (matches = text.match(/(.*),\s+(.*)/)) {
		lastname = matches[1];
		firstname = matches[2];
		pieces = firstname.split(/\s+/);
		abbrname = "";
		for (var i=0; i<pieces.length; i++) {
			if (pieces[i][0] == pieces[i][0].toLowerCase()) {
				// such as "del"
				abbrname += " " + pieces[i];
			} else if (pieces[i][0] == pieces[i][0].toUpperCase()) {
				abbrname += " " + pieces[i][0] + ".";
			} else {
				// strange case
				abbrname += " " + pieces[i];
			}
		}
		var shortname;
		if (abbrname.length > 0) {
			shortname = lastname + "," + abbrname;
		} else {
			shortname = lastname;
		}
		if (shortname.length > 15) {
			output = "<span style='letter-spacing:-1px; word-spacing:-1px; ";
			output+= "cursor:help' title='" + firstname + " " + lastname +"'>";
			output += shortname + "</a>";
		} else {
			output = "<span style='cursor:help' title='";
			output += firstname + " " + lastname +"'>";
			output += shortname + "</a>";
		}
		return new Handlebars.SafeString(output);
	} else {
		return new Handlebars.SafeString(text);
	}
});

</script>
