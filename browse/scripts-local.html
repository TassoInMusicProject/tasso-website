<script src="/scripts/scripts-common.js"></script>

{% include_relative templates.html %}
{% include_relative listeners.html %}

<script>
// vim: ts=3


var MUSICFIELDS    = {};
var LITERARYFIELDS = {};


var RIMESETTINGLIST = [];
var RIMEVERSELIST = [];

document.addEventListener("DOMContentLoaded", function() {
	HighlightNavigationBar();
	displayMusicPolicies();
});



//////////////////////////////
//
// displayMusicPolicies -- Show music editorial policy target element.
//

function displayMusicPolicies(target) {
	if (!target) {
		target = "#contents";
	}
	var element = document.querySelector(target);
	if (!element) {
		console.log("Error: cannot place Music Policy content on page.");
		return;
	}
	showTab("music-heading");
	var request = new XMLHttpRequest();
	request.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
			element.innerHTML = request.responseText;
			setupMusicBrowseCallbacks();
			fillMusicBrowsePage();
			insertCgiSearchParameters();
		}
	};
	request.open("GET", "music.html", true);
	request.send();
}



//////////////////////////////
//
// displayTextPolicies -- Show text editorial policy target element.
//

function displayTextPolicies(target) {
	if (!target) {
		target = "#contents";
	}
	var element = document.querySelector(target);
	if (!element) {
		console.log("Error: cannot place Text Policy content on page.");
		return;
	}
	showTab("text-heading");
	var request = new XMLHttpRequest();
	request.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
			element.innerHTML = request.responseText;
			setupLiteraryBrowseCallbacks();
			fillLiteraryBrowsePage();
		}
	};
	request.open("GET", "text.html", true);
	request.send();
}



//////////////////////////////
//
// showTab --
//

function showTab(hiid) {
	var music     = document.querySelector("#music-heading");
	var text      = document.querySelector("#text-heading");

	music.className   = hiid == "music-heading"   ? "active" : "";
	text.className    = hiid == "text-heading"    ? "active" : "";

	fillMusicBrowsePage();
	fillLiteraryBrowsePage();

}



//////////////////////////////
//
// fillMusicBrowsePage --
//

function fillMusicBrowsePage() {
	var music = document.querySelector("#music-heading");
	if (!music) {
		return;
	}
	if (!music.className.match(/active/)) {
		return;
	}
	var works = filterMusicData(RIMESETTINGLIST);
	var count = works.length;
	var countElement = document.querySelector("#work-count");
	if (countElement) {
		if (count == 1) {
			countElement.innerHTML = count + " entry";
		} else {
			countElement.innerHTML = count + " entries";
		}
	}
	displayMusicBrowseEntries(works);
}



//////////////////////////////
//
// fillLiteraryBrowsePage --
//

function fillLiteraryBrowsePage() {
	var literary = document.querySelector("#text-heading");
	if (!literary) {
		return;
	}
	if (!literary.className.match(/active/)) {
		return;
	}
	var works = filterLiteraryData(RIMEVERSELIST);
	var count = works.length;
	var countElement = document.querySelector("#work-count");
	if (countElement) {
		if (count == 1) {
			countElement.innerHTML = count + " entry";
		} else {
			countElement.innerHTML = count + " entries";
		}
	}
	displayLiteraryBrowseEntries(works);
}



//////////////////////////////
//
// filterMusicData --
//

function filterMusicData(entries) {
	if (!entries) {
		entries = RIMESETTINGLIST;
	}
	if (!entries) {
		return [];
	}
	if (!entries.length) {
		return [];
	}

	output = entries;

	var composerElement = document.querySelector("#browse-composer");
	var composer = "";
	if (composerElement) {
		composer = composerElement.value;
	}

	var titleElement = document.querySelector("#browse-title");
	var title = "";
	if (titleElement) {
		title = titleElement.value;
	}

	var locationElement = document.querySelector("#browse-location");
	var location = "";
	if (locationElement) {
		location = locationElement.value;
	}

	var yearElement = document.querySelector("#browse-year");
	var year = "";
	if (yearElement) {
		year = yearElement.value;
	}

	var publisherElement = document.querySelector("#browse-publisher");
	var publisher = "";
	if (publisherElement) {
		publisher = publisherElement.value;
	}

	var rismElement = document.querySelector("#browse-rism");
	var rism = "";
	if (rismElement) {
		rism = rismElement.value;
	}

	var ovoicesElement = document.querySelector("#browse-ovoices");
	var ovoices = "";
	if (ovoicesElement) {
		ovoices = ovoicesElement.value;
	}
	var evoicesElement = document.querySelector("#browse-evoices");
	var evoices = "";
	if (evoicesElement) {
		evoices = evoicesElement.value;
	}

	if (composer) {
		output = filterByField(output, "COMPOSER", composer);
	}
	if (title) {
		// change this to title? But there is the setting title as well.
		output = filterByField(output, "RIMETITLE", title);
	}
	if (location) {
		output = filterByField(output, "NORMLOC", location);
	}
	if (year) {
		output = filterByField(output, "PRINCEPSYEAR", year);
	}
	if (publisher) {
		output = filterByField(output, ["NORMPUBSHORT", "NORMPUB", "PRINCEPSPUB"], publisher);
	}
	if (rism) {
		output = filterByField(output, "PRINCEPSRISM", rism);
	}
	if (ovoices) {
		output = filterByField(output, "OVOICES", ovoices);
	}
	if (evoices) {
		output = filterByField(output, "EXTANTVOICES", evoices);
	}


	return output;
}



//////////////////////////////
//
// filterLiteraryData --
//

function filterLiteraryData(entries) {
	if (!entries) {
		entries = RIMEVERSELIST;
	}
	if (!entries) {
		return [];
	}
	if (!entries.length) {
		return [];
	}

	output = entries;

	var titleElement = document.querySelector("#browse-title");
	var title = "";
	if (titleElement) {
		title = titleElement.value;
	}

	var dedicateeElement = document.querySelector("#browse-dedicatee");
	var dedicatee = "";
	if (dedicateeElement) {
		dedicatee = dedicateeElement.value;
	}

	var litgenElement = document.querySelector("#browse-litgen");
	var litgen = "";
	if (litgenElement) {
		litgen = litgenElement.value;
	}

	var manusrcElement = document.querySelector("#browse-manusrc");
	var manusrc = "";
	if (manusrcElement) {
		manusrc = manusrcElement.value;
	}

	var printsrcElement = document.querySelector("#browse-printsrc");
	var printsrc = "";
	if (printsrcElement) {
		printsrc = printsrcElement.value;
	}

	if (title) {
		output = filterByField(output, "TITLE", title);
	}

	if (dedicatee) {
		output = filterByField(output, "DEDICATEE", dedicatee);
	}

	if (litgen) {
		output = filterByField(output, "GENRE", litgen);
	}

	if (manusrc) {
		output = filterByField(output, "MANUSRC", manusrc);
	}

	if (printsrc) {
		output = filterByField(output, "PRINTSRC", printsrc, true);
	}

	return output;
}



//////////////////////////////
//
// filterByField --
//

function filterByField(entries, field, value, bound) {
	if (!entries) {
		return [];
	}
	if (entries.length == 0) {
		return [];
	}
	var output = [];

	// fix for regular expressions:
	//value = value.replace(/'/g, "\\\'");

	if (bound) {
		value = "\\b" + value + "\\b";
	}
	var re = new RegExp(value, "i");
	for (var i=0; i<entries.length; i++) {
		if (field instanceof Array) {
			var found = 0;
			for (var j=0; j<field.length; j++) {
				if (!entries[i][field[j]]) {
					continue;
				}
				if (entries[i][field[j]].match(re)) {
					found = 1;
					break;
				}
			}
			if (found) {
				output.push(entries[i]);
			}
		} else {
			if (!entries[i][field]) {
				continue;
			}
			if (entries[i][field].match(re)) {
				output.push(entries[i]);
			}
		}
	}

	return output;
}



//////////////////////////////
//
// displayMusicBrowseEntries --
//

function displayMusicBrowseEntries(entries) {
	var element = document.querySelector("#browse-results");
	if (!element) {
		return;
	}

	if (entries.length == 0) {
		element.innerHTML = "No matches";
		return;
	}
	var tsource = document.querySelector("#music-browse-template").textContent;
	var template = Handlebars.compile(tsource);
	element.innerHTML = template(entries);
}



//////////////////////////////
//
// insertCgiSearchParameters -- Take browse parameters from the
//     URL and insert into search fields.
//

function insertCgiSearchParameters() {

	if (CGI.year) {
		var yearelement = document.querySelector("#browse-year");
		if (yearelement) {
			yearelement.value = CGI.year;
		}
	}

	if (CGI.location) {
		var locationelement = document.querySelector("#browse-location");
		if (locationelement) {
			locationelement.value = CGI.location;
		}
	}

	if (CGI.publisher) {
		var publisherelement = document.querySelector("#browse-publisher");
		if (publisherelement) {
			publisherelement.value = CGI.publisher;
		}
	}

	if (CGI.rism) {
		var rismelement = document.querySelector("#browse-rism");
		var rism = cleanRismText(CGI.rism);
		if (rismelement) {
			rismelement.value = rism;
		}
	}

	if (CGI.composer) {
		var composerelement = document.querySelector("#browse-composer");
		var composer = CGI.composer;
		if (composerelement) {
			composerelement.value = composer;
		}
	}

	if (CGI.title) {
		var titleelement = document.querySelector("#browse-title");
		var title = CGI.title;
		if (titleelement) {
			titleelement.value = title;
		}
	}

}



///////////////////////////////
//
// cleanRismText -- Format RISM A/I correctly.
//

function cleanRismText(rism) {
	var matches;
	if (matches = rism.match(/^([A-Z])(\d+)$/)) {
		rism = matches[1] + " " + matches[2];
	} else if (matches = rism.match(/^([A-Z])-(\d+)$/)) {
		rism = matches[1] + " " + matches[2];
	} else if (matches = rism.match(/^([A-Z])_(\d+)$/)) {
		rism = matches[1] + " " + matches[2];
	} else if (matches = rism.match(/^([a-z])(\d+)$/)) {
		rism = matches[1].toUpperCase() + " " + matches[2];
	} else if (matches = rism.match(/^([a-z])-(\d+)$/)) {
		rism = matches[1].toUpperCase() + " " + matches[2];
	} else if (matches = rism.match(/^([a-z])_(\d+)$/)) {
		rism = matches[1].toUpperCase() + " " + matches[2];
	}
	return rism;
}



//////////////////////////////
//
// displayLiteraryBrowseEntries --
//

function displayLiteraryBrowseEntries(entries) {
	var element = document.querySelector("#browse-results");
	if (!element) {
		return;
	}

	if (entries.length == 0) {
		element.innerHTML = "No matches";
		return;
	}
	var tsource = document.querySelector("#literary-browse-template").textContent;
	var template = Handlebars.compile(tsource);
	element.innerHTML = template(entries);
}



///////////////////////////////
//
//  "DOMContentLoaded" --
//

window.addEventListener("DOMContentLoaded", function() {

	// if (sessionStorage.RIMESETTINGLIST) {
		var request = new XMLHttpRequest();
		request.open("GET", "{{site.rime_settings}}");
		request.addEventListener("load", function() {
			var aton = new ATON;
			RIMESETTINGLIST = aton.parse(this.responseText).SETTING;
			sessionStorage.RIMESETTINGLIST = JSON.stringify(RIMESETTINGLIST);
			fillMusicBrowsePage();
		});
		request.send();
	// }

	// if (sessionStorage.RIMEVERSELIST) {
		var request = new XMLHttpRequest();
		request.open("GET", "{{site.rime_verses}}");
		request.addEventListener("load", function() {
			var aton = new ATON;
			RIMEVERSELIST = aton.parse(this.responseText).RIME;
			sessionStorage.RIMEVERSELIST = JSON.stringify(RIMEVERSELIST);
			fillLiteraryBrowsePage();
		});
		request.send();
	// }

});


//////////////////////////////
//
// setupMusicBrowseCallbacks --
//

function setupMusicBrowseCallbacks() {

	var composerElement = document.querySelector("#browse-composer");
	if (composerElement) {
		composerElement.addEventListener("input", function() { 
			fillMusicBrowsePage();
		});
	}

	var titleElement = document.querySelector("#browse-title");
	if (titleElement) {
		titleElement.addEventListener("input", function() { 
			fillMusicBrowsePage();
		});
	}

	var locationElement = document.querySelector("#browse-location");
	if (locationElement) {
		locationElement.addEventListener("input", function() { 
			fillMusicBrowsePage();
		});
	}

	var yearElement = document.querySelector("#browse-year");
	if (yearElement) {
		yearElement.addEventListener("input", function() { 
			fillMusicBrowsePage();
		});
	}

	var publisherElement = document.querySelector("#browse-publisher");
	if (publisherElement) {
		publisherElement.addEventListener("input", function() { 
			fillMusicBrowsePage();
		});
	}

	var rismElement = document.querySelector("#browse-rism");
	if (rismElement) {
		rismElement.addEventListener("input", function() { 
			fillMusicBrowsePage();
		});
	}

	var ovoicesElement = document.querySelector("#browse-ovoices");
	if (ovoicesElement) {
		ovoicesElement.addEventListener("input", function() { 
			fillMusicBrowsePage();
		});
	}

	var evoicesElement = document.querySelector("#browse-evoices");
	if (evoicesElement) {
		evoicesElement.addEventListener("input", function() { 
			fillMusicBrowsePage();
		});
	}

}



//////////////////////////////
//
// setupLiteraryBrowseCallbacks --
//

function setupLiteraryBrowseCallbacks() {

	var titleElement = document.querySelector("#browse-title");
	if (titleElement) {
		titleElement.addEventListener("input", function() { 
			fillLiteraryBrowsePage();
		});
	}

	var dedicateeElement = document.querySelector("#browse-dedicatee");
	if (dedicateeElement) {
		dedicateeElement.addEventListener("input", function() { 
			fillLiteraryBrowsePage();
		});
	}

	var litgenElement = document.querySelector("#browse-litgen");
	if (litgenElement) {
		litgenElement.addEventListener("input", function() { 
			fillLiteraryBrowsePage();
		});
	}

	var manusrcElement = document.querySelector("#browse-manusrc");
	if (manusrcElement) {
		manusrcElement.addEventListener("input", function() { 
			fillLiteraryBrowsePage();
		});
	}

	var printsrcElement = document.querySelector("#browse-printsrc");
	if (printsrcElement) {
		printsrcElement.addEventListener("input", function() { 
			fillLiteraryBrowsePage();
		});
	}

}


//////////////////////////////
//
// sortByText --
//

function sortByText(index, selector) {
	var data = document.querySelectorAll(".data");
	var datalist = [];
	var i;
	for (i=0; i<data.length; i++) {
		datalist.push(data[i]);
	}
	datalist.sort(function(a, b) {
		var A;
		var B;
		if (selector) {
			A = a.cells[index].querySelector(selector).innerHTML;
			B = b.cells[index].querySelector(selector).innerHTML;
		} else {
			A = a.cells[index].textContent;
			B = b.cells[index].textContent;
		}
		if (A.match(/^\s*$/)) {
			return +1;
		}
		if (B.match(/^\s*$/)) {
			return -1;
		}
		var result = A.localeCompare(B);
		return result;
	});

	var body = document.querySelector("table.music-browse-list tbody");
	if (body === null) {
		body = document.querySelector("table.literary-browse-list tbody");
	}
	body.innerHTML = "";
	for (i=0; i<datalist.length; i++) {
		body.appendChild(datalist[i]);
	}
}



//////////////////////////////
//
// sortByVoice -- Currently the same as sortByText, but may change in the future.
//

function sortByVoice(index, selector) {
	var data = document.querySelectorAll(".data");
	var datalist = [];
	var i;
	for (i=0; i<data.length; i++) {
		datalist.push(data[i]);
	}
	datalist.sort(function(a, b) {
		var A;
		var B;
		if (selector) {
			A = a.cells[index].querySelector(selector).innerHTML;
			B = b.cells[index].querySelector(selector).innerHTML;
		} else {
			A = a.cells[index].textContent;
			B = b.cells[index].textContent;
		}
		if (A.match(/^\s*$/)) {
			return +1;
		}
		if (B.match(/^\s*$/)) {
			return -1;
		}
		var result = A.localeCompare(B);
		return result;
	});

	var body = document.querySelector("table.music-browse-list tbody");
	if (body === null) {
		body = document.querySelector("table.literary-browse-list tbody");
	}
	body.innerHTML = "";
	for (i=0; i<datalist.length; i++) {
		body.appendChild(datalist[i]);
	}
}



//////////////////////////////
//
// sortByYear --
//

function sortByYear(index, selector) {
	var data = document.querySelectorAll(".data");
	var datalist = [];
	var i;
	for (i=0; i<data.length; i++) {
		datalist.push(data[i]);
	}
	datalist.sort(function(a, b) {
		var A;
		var B;
		if (selector) {
			A = a.cells[index].querySelector(selector).innerHTML;
			B = b.cells[index].querySelector(selector).innerHTML;
		} else {
			A = a.cells[index].textContent;
			B = b.cells[index].textContent;
		}
		var matches;
		if (matches = A.match(/(\d{4})/)) {
			A = matches[1];
		} else {
			A = "";
		}
		if (matches = B.match(/(\d{4})/)) {
			B = matches[1];
		} else {
			B = "";
		}
		if (A.match(/^\s*$/)) {
			return +1;
		}
		if (B.match(/^\s*$/)) {
			return -1;
		}
		var result = A.localeCompare(B);
		return result;
	});

	var body = document.querySelector("table.music-browse-list tbody");
	if (body === null) {
		body = document.querySelector("table.literary-browse-list tbody");
	}
	body.innerHTML = "";
	for (i=0; i<datalist.length; i++) {
		body.appendChild(datalist[i]);
	}
}



//////////////////////////////
//
// displaySingleWork --
//

function displaySingleWork(id) {
	if (!id) {
		return;
	}
	window.location.href = "/work?id=" + id;
}


</script>

