#!/usr/bin/perl
# Programmer:    Craig Stuart Sapp <craig.stanford.edu>
# Creation Date: Tue Sep 25 07:26:08 PDT 2018
# Last Modified: Wed Sep 26 06:13:28 PDT 2018
# Filename:      makesourceaton
# Syntax:        perl 5
# vim:           ts=3
#
# Description:   This program downloads the sources index spreadsheet
#                from Google Spreadsheets and creates an ATON file with
#                the same contents.  
#
# Note:          wget must be installed, which is common on linux computers by default.
#                On MacOS computers, install http://brew.sh, and then install with the
#                command "brew wget".

use strict;

# sources spreadsheet:
my $id = "1YcaAQc-mxFFDWyOsT7HOlwZkEqB4rPEuOzXCMTKprMc";
my $gid = "266005788";
my $url = "https://docs.google.com/spreadsheets/d/$id/export?gid=$gid&format=tsv";
my $contents = `wget -O - "$url"`;
die "Problem downloading data\n" if $contents =~ /^\s*$/;
my @spreadsheet = split(/[\n\r]+/, $contents);
my $linecount = @spreadsheet;
die "Problem downloading data: not enough content.\n" if $linecount < 200;


printHeader();


my $headerline = $spreadsheet[0];;
chomp $headerline;
my @headings = split(/\t/, $headerline);

for (my $i=1; $i<@spreadsheet; $i++) {
	my $line = $spreadsheet[$i];
	chomp $line;
	my @data = split(/\t/, $line);
	print "\@\@BEGIN: SOURCE\n";
	for (my $i=0; $i<@headings; $i++) {
		print "\@$headings[$i]:\t$data[$i]\n";
	}
	print "\@\@END: SOURCE\n\n";
}



##############################
##
## printHeader --
##

sub printHeader {

print <<"EOT";
\@\@
\@\@ File: http://www.tassomusic.org/data/indexes/sources.aton
\@\@
\@\@ Musical sources index.
\@\@
\@\@ This database lists publications in which the musical settings
\@\@ of Torquato Tasso's rime are published.  This file can be 
\@\@ cross-indexed with the settings files by RISM number.
\@\@
\@\@ Do not edit this file directly, as it is automatically generated.
\@\@ Make changes to the contents on the spreadsheet:
\@\@    https://docs.google.com/spreadsheets/d/1YcaAQc-mxFFDWyOsT7HOlwZkEqB4rPEuOzXCMTKprMc/edit#gid=266005788
\@\@ and then type "make sources" in this directory to update this file.
\@\@
\@\@ Meaning of the entries in each record:
\@\@   BEGIN: SOURCE     Start of a source entry.
\@\@   RISM:             RISM A/I or B/I number for the source.
\@\@   AUTHOR:           Author of the source.
\@\@   TITLEPAGE:        Title page (long title) of the source (displayed on work pages).
\@\@   TITLESHORT:       Short title of the source (displayed in settings list pages).
\@\@   PUBLISHER:        Publisher of the source.
\@\@   YEAR:             Year the source was published.
\@\@   PUBTYPE:          Whether the publication is for a single composer or an anthology.
\@\@   PUBFORMAT:        Format of the publication (part-books, choir, etc).
\@\@   PUBLOC:           Location (city) of publication.
\@\@   PUBNORMLOC:       Location of the publication in modern English spelling.
\@\@   SRCDEDICATEE:     Dedicatee of the source.
\@\@   OPARTBOOKS:       Original partbooks.
\@\@   EXTPARTBOOKS:     Extant partbooks.
\@\@   SRCLOCSIGLA:      Library sigla of the digital image of source.
\@\@   REPRODUCTIONTYPE: Type of digital resource.
\@\@   SRCURL:           Digital resource URL.
\@\@   END: SOURCE       End of a source entry.
\@\@


EOT


}



