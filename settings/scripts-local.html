
<script src="/scripts/scripts-common.js"></script>

<script>
//
// Programmer:    Craig Stuart Sapp <craig@ccrma.stanford.edu>
// Creation Date: Sat Mar 26 07:56:45 PDT 2016
// Last Modified: Tue Mar 28 08:26:04 PDT 2017
// Filename:      settings/scripts-local.html
// Syntax:        JavaScript 1.8/ECMAScript 5
// vim:           ts=3: ft=javascript
//
// Description:   JavaScript management for the musical settings.
//

var Rime         = 0;
var NextRime     = 0;
var PreviousRime = 0;

var RWORKLIST = {};

//////////////////////////////
//
// Function called when document has finished loading:
//

document.addEventListener("DOMContentLoaded", function() {
	var cgi = GetCgiParameters();
	if (cgi.rime) {
		Rime = cgi.rime;
	   displayMusicalSettings(cgi.rime, "#contents");
	} else {
	   displayMusicalSettings(0, "#contents");
	}
});


//////////////////////////////
//
// click event listener -- Find a <tr>, then go ot the ending
// <td> and use that as an ID (if it has the form of Trm0000z).
//

document.addEventListener("click", function(event) {
	target = event.target;
	while (target) {
 		if (target.nodeName == "TH") {
			return;
		}
 		if (target.nodeName != "TR") {
			target = target.parentNode;
         continue;
		}
		var lasttd = target.querySelector("td:first-child");
		var id = lasttd.textContent;
		if (!RWORKLIST[id]) {
         // id has no workpage content
			return;
		}

		if (id.match("^Trm")) {
			var url = "/work?id=" + id;
			window.location = url;
		}
		break;
	}
});


//////////////////////////////
//
// process Window keys down:
//

window.addEventListener('keydown', function(event) {
	if (event.metaKey) {
		return;
	}

	switch (event.keyCode) {
		case LeftArrowKey:
			if (event.shiftKey) {
				displayVariant();
			} else {
				displayPreviousSetting();
			}
			break;
		case RightArrowKey:
			if (event.shiftKey) {
				displaySource();
			} else {
				displayNextSetting();
			}
			break;
		case UpArrowKey:
			window.location = "/settings";
			break;
	}

});



//////////////////////////////
//
// displaySource --
//

function displaySource() {
	if (Rime) {
		window.location = "/sources/?rime=" + Rime;
	} else {
		window.location = "/sources";
	}
}



//////////////////////////////
//
// displayVariant --
//

function displayVariant() {
	if (Rime) {
		window.location = "/variants/?rime=" + Rime;
	} else {
		window.location = "/variants";
	}
}



//////////////////////////////
//
// displayNextSetting --
//

function displayNextSetting() {
	displayMusicalSettings(NextRime);
}



//////////////////////////////
//
// displayPreviousSetting --
//

function displayPreviousSetting() {
	displayMusicalSettings(PreviousRime);
}



//////////////////////////////
//
// displayMusicalSettings -- Show the literary sources for the given
// 	Rime.
//

function displayMusicalSettings(rime, target) {
	if (!target) {
		target = "#contents";
	}
	var element = document.querySelector(target);
	if (!element) {
		console.log("Error: cannot place Rime literary sources on page.");
		return;
	}

	var counter = 0;

	if (sessionStorage.SETLIST) {
		SETLIST = JSON.parse(sessionStorage.SETLIST);
		counter++;
	} else {
		var request = new XMLHttpRequest();
		request.open("GET", "{{site.rime_settings}}");
		request.addEventListener("load", function() {
			var aton = new ATON;
			SETLIST = aton.parse(this.responseText).RIME_SETTING;
			sessionStorage.SETLIST = JSON.stringify(SETLIST);
			counter++;
			if (counter == 3) {
				reallyDisplaySettings(rime, target);
				counter++;
			}
		});
		request.send();
	}

	if (sessionStorage.RIMELIST) {
		RIMELIST = JSON.parse(sessionStorage.RIMELIST);
		setNextPreviousRime(rime);
		counter++;
	} else {
		var request = new XMLHttpRequest();
		request.open("GET", "{{site.rime_settings}}");
		request.addEventListener("load", function() {
			var aton = new ATON;
			RIMELIST = aton.parse(this.responseText);
			setNextPreviousRime(rime);
			sessionStorage.RIMELIST = JSON.stringify(RIMELIST);
			counter++;
			if (counter == 3) {
				reallyDisplaySettings(rime, target);
				counter++;
			}
		});
		request.send();
	}

	if (sessionStorage.WORKLIST) {
		WORKLIST = JSON.parse(sessionStorage.WORKLIST);
		counter++;
	} else {
		var request = new XMLHttpRequest();
		request.open("GET", "{{site.workist}}");
		request.addEventListener("load", function() {
			WORKLIST = JSON.parse(this.responseText);
			setNextPreviousRime(rime);
			sessionStorage.WORKLIST = this.responseText;
			counter++;
			if (counter == 3) {
				reallyDisplaySettings(rime, target);
				counter++;
			}
		});
		request.send();
	}

	if (counter == 3) {
		reallyDisplaySettings(rime, target);
		counter++;
	}
}



//////////////////////////////
//
// reallyDisplaySettings --
//

function reallyDisplaySettings(rime, target) {
	if (!target) {
		target = "#contents";
	}
	var element = document.querySelector(target);
	if (!element) {
		console.log("Error: cannot place Rime literary sources on page.");
		return;
	}
	buildReverseWorklist();

	var output = "";
	if (!rime) {
		output += displayMultipleRimeSettings();
	} else {
		output += displaySingleRimeSetting(rime);
	}
	element.innerHTML = output;
}



//////////////////////////////
//
// buildReveseWorklist --
//

function buildReverseWorklist() {
	RWORKLIST = {};
	var wl = WORKLIST[0].works;
	for (var i in wl) {
		RWORKLIST[wl[i].id] = 1;
	}
}



//////////////////////////////
//
// displayMultipleRimeSettings --
//

function displayMultipleRimeSettings() {
	var output = "";
	output += "<div style='font-size:100%; margin-left:0px'>";
	output += "<center>";
	output += "<h1 style='margin-top:0; padding-right:50px;'>Musical Settings</h1>";
	output += "</center>";

	var rimelist = RIMELIST.RIME;
	var rime;
	for (var i=0; i<rimelist.length; i++) {
		output += "<center><table style='margin-top:10px; ";
		output += "padding:0; padding-right:50px; width:100%'><tr>";
		output += "<td>";
		output += "</td><td style='width:100%; text-align:center'>";
		output += "<h2>";
		rime = rimelist[i].SOLERTI;
		var rime_entry = rimelist[i];
		if (!rime_entry) {
			console.log("Error accessing rime:", rime);
			return;
		}
		output += rime_entry.TITLE;
		output += "(<i>Rime</i> " + rime + ")<h2>";
		output += "</td><td>";
		output += "</td></tr>";
		output += "</table></center>";

		var table = getMusicalSettingTable(rime_entry);
		output += table;
	}
	output += "</div>\n";
	return output;
}



//////////////////////////////
//
// displaySingleRimeSetting --
//

function displaySingleRimeSetting(rime) {
	var output = "";
//	output += "<div style='font-size:100%; margin-left:50px'>";
//	output += "<center>";
//	output += "<h1 style='padding-right:50px;'>Musical Settings</h1>";
//	output += "</center>";

	output += "<center><table style=' width=100%;";
	output += "padding-top:-50px; padding-left:0px; padding-right:0px; width:100%'><tr>";
	output += "<td class='triangle'><span class='triangle' ";
	output += " onclick='displayVariant();'";
	output += "href='/sources?rime=";
	output += PreviousRime + "'>";
	output += "<span style='letter-spacing:-7pt;'>";
	output += "&#9664;&#9664;</span></a>";
	output += "</td><td style='width:100%; text-align:center'>";
	output += "<h1 style='margin-top:0;'>Musical Settings</h1>";
	output += "</td><td class='triangle'>";
	output += "<span class='triangle'";
	output += " onclick='displaySource();'";
	output += " href='/sources?rime=";
	output +=  NextRime + "'>";
	output += "<span style='position:relative;left:-8px; letter-spacing:-7pt;'>";
	output += "&#9654;&#9654;</span></a>";
	output += "</td></tr>";
	output += "</table></center>";

	output += "<center><table style='width=100%; margin-top:-50px; ";
	output += "padding-left:0px; padding-right:0px; width:100%'><tr>";
	output += "<td class='triangle'><span class='triangle' ";
	output += " onclick='displayPreviousSetting();'>";
	output += "&#9664;</span>";
	output += "</td><td style='width:100%; text-align:center'>";
	output += "<h2>";
	var rime_entry = GetRimeEntry(rime);
	if (!rime_entry) {
		console.log("Error accessing rime:", rime);
		return;
	}
	var title = rime_entry.TITLE;
	title = title.replace("ANGIOLETTA", "<span class=name>A<font style=\"font-variant:small-caps\">ngioletta</font></span>");
	title = title.replace("BARBARA", "<span class=name>B<font style=\"font-variant:small-caps\">arbara</font></span>");
	title = title.replace("Angioletta", "<span class=name>A<font style=\"font-variant:small-caps\">ngioletta</font></span>");
	title = title.replace("Barbara", "<span class=name>B<font style=\"font-variant:small-caps\">arbara</font></span>");
	output += title;
	output += " (<i>Rime</i> " + rime + ")<h2>";
	output += "</td><td class='triangle'>";
	output += "<span class='triangle'";
	output += " onclick='displayNextSetting();'>";
	output += "&#9654;</a>";
	output += "</td></tr>";
	output += "</table></center>";

	var table = getMusicalSettingTable(rime_entry);
	output += table;
	output += "</div>\n";
	return output;

}



//////////////////////////////
//
// buildSetList --
//

function buildSetList(rime_entry) {
	var solerti = rime_entry.SOLERTI;
	solerti = solerti.replace(/^\s+/, "").replace(/\s+$/, "");
	if (!solerti) {
		return;
	}
	key = "Trm";
	if (solerti < 1000) { key += "0"; }
	if (solerti < 100) { key += "0"; }
	if (solerti < 10) { key += "0"; }
	key += solerti;
	var WORKS = [];
	var WLIST = SETLIST;
	for (var i=0; i<WLIST.length; i++) {
		if (WLIST[i].CATALOGNUM.match(key)) {
			WLIST[i].SOLERTI = solerti;
			WORKS.push(WLIST[i]);
		}
	}
	WORKS.sort(function (a, b) {
		if (a.CATALOGNUM < b.CATALOGNUM) {
			return -1;
		} else if (a.CATALOGNUM > b.CATALOGNUM) {
			return +1;
		}
		return 0;
	});
	rime_entry.WORKS = WORKS;
}



//////////////////////////////
//
// getMusicalSettingTable --
//

function getMusicalSettingTable(rime_entry) {
	if (!rime_entry) {
		return ""
	}
	if (!rime_entry.WORKS) {
		buildSetList(rime_entry);
	}
	var tsource = document.querySelector("#settings-template")
	                      .textContent;
	var settingTemplate = Handlebars.compile(tsource);
	var output = settingTemplate(rime_entry);
	return output;
}



//////////////////////////////
//
// setNextPreviousRime --
//

function setNextPreviousRime(rime) {
	Rime = rime;
	NextRime = rime;
	PreviousRime = rime;

	var index = -1;
	var list = RIMELIST.RIME;
	for (var i=0; i<list.length; i++) {
		if (rime == list[i].SOLERTI) {
			index = i;
			break;
		}
	}
	
	if (index < 0) {
		return;
	}

	if (index < list.length - 1) {
		NextRime = list[index+1].SOLERTI;
	} else {
		NextRime = list[0].SOLERTI;
	}

	if (index > 0) {
		PreviousRime = list[index-1].SOLERTI;
	} else {
		PreviousRime = list[list.length-1].SOLERTI;
	}
}


</script>


<!-- HANDLEBARS TEMPLATES -------------------------------------- -->

<!-- rime-template
		The rime template is used to fill in the list of poems
		on the homepage.  The list of poems is found in the file
		data/indexes/rime-settings.aton.

	 WORKS entry example:
			"CATALOGNUM": "Trm0288l",
			"POEMTITLE": "Amatemi, ben mio",
			"SOLERTI": "sm288",
			"COMPOSER": "Aagesen, Truid",
			"COMDATES": "",
			"PRINCEPS": "Cantiones trium vocum. Hamburg, 1608 (RISM S3549)",
			"REPRINTS": "",
			"REPORTS": "",
			"OCLEFS": "",
			"OTIME": "@KEYSIG",
			"NOTE": ""
-->

{% raw %}
<script id="settings-template" type="text/x-handlebars-template">
	<table class="settings">
	<thead>
		<th onclick="sortByText(event, 0)" style="cursor:pointer; padding-bottom:20px">Catalog&nbsp;#</th>
		<th onclick="sortByText(event, 1)" style="cursor:pointer; text-align:left">Composer</th>
		<th onclick="sortByPublication(event, 2)" style="cursor:pointer; text-align:left">Source</th>
	<thead>
	<tbody>
	{{#WORKS}}
	{{{trclass CATALOGNUM}}}
	<td>{{CATALOGNUM}}</td>
	<td><nobr>{{{shortcomposer COMPOSER}}}</nobr></td>
	<td>{{{printsource PRINCEPSTITLE PRINCEPSLOC PRINCEPSPUB PRINCEPSYEAR}}}</td>
	</tr>
	{{/WORKS}}
	</tbody>
	</table>
</script>
{% endraw %}


<script>


//////////////////////////////
//
// tclass Handlebar helper -- Set the class to whether or note there is
//     a work page for this ID.
//

Handlebars.registerHelper("trclass", function(id) {
	var output = "";
	if (RWORKLIST[id]) {
		output += "<tr class='data haswork'>";
	} else {
		output += "<tr class='data nowork'>";
	}
	return new Handlebars.SafeString(output);
});



//////////////////////////////
//
// printsource Handlebar helper --
//

Handlebars.registerHelper("printsource", function(title, loc, pub, year) {
   title = title.replace(/<\/i>\.$/, "</i>");
   title = title.replace(/\.<\/i>$/, "</i>");
	var output = "";
	output = title;
	if (loc || pub || year) {
		output += "<span class=publication>";
		output += "&nbsp;&nbsp;";
		output += "(";
		if (loc && pub && year) {
			output += loc + ": " + pub + ", " + year;
		} else if (loc && pub) {
			output += loc + ": " + pub;
		} else if (loc && year) {
			output += loc + ", " + year;
		} else if (pub && year) {
			output += pub + ", " + year;
		} else if (loc) {
			output += loc;
		} else if (pub) {
			output += pub;
		} else if (year) {
			output += year;
		}
		output += ")";
		output += "</span>";
   }
	return new Handlebars.SafeString(output);
});


//////////////////////////////
//
// princeps Handlebar helper  -- Format text.
//

Handlebars.registerHelper("princeps", function(title, rism) {
	var matches;
	var lowcut = 70;
	var midcut = 80;
	var hicut = 90;
	var title;
	var pubinfo;
	var output = title + "<br>" + rism;
	if (rism) {
		rism = rism.replace("Unkwnown", "Unknown");
		rism = rism.replace(/\s+/g, "&nbsp;");
		rism = "<br><span class='rism'>" + rism + "</span>";
	}
	if (matches = title.match(/(.*)<\/i>(.*)/)) {
		title = matches[1] + "</i>";
		pubinfo = matches[2];
		output = title;
		if (title.length < 60) {
			// output = title;
			output = "<span style='word-spacing:1px'>" + title + "</span>";
		} else if (title.length > 90) {
			output = "<span style='font-size:96%; word-spacing:-1px; ";
			output += "letter-spacing:-1px;'>";
			output += title + "</span>";
		} else if (title.length > 70) {
			output = "<span style='font-size:97%; word-spacing:-1px; ";
			output += "letter-spacing:-1px;'>";
			output += title + "</span>";
		}
		output += " " + pubinfo + " ";
		// output += "<br>" + pubinfo + " ";
		if (rism && (rism.length > 50)) {
			output += "<span style='font-size:95%; word-spacing:-1px; ";
			output += "letter-spacing:-1px;'>" + rism + "</span>";
		} else if (rism) {
			output += rism;
		}
	}
	return new Handlebars.SafeString(output);
});



Handlebars.registerHelper("princepspub", function(loc, pub) {
	var output = "";
	if (loc && pub) {
		output += loc + ": " + pub;	
	} else if (loc) {
		output += loc;
	} else if (pub) {
		output += pub;
	}
	return new Handlebars.SafeString(output);
});


Handlebars.registerHelper("princepsyear", function(year) {
	var output = "";
	output = year.replace(/-+/g, "&ndash;");
	output = "<nobr>" + output + "</nobr>";
	return new Handlebars.SafeString(output);
});



//////////////////////////////
//
// shortcomposer Handlebar helper  -- Prevent linebreak after RISM
//      and its number.
//

Handlebars.registerHelper("shortcomposer", function(text) {
	var matches;
	text = text.replace(/^\s+/, "").replace(/\s+$/, "");
	var lastname = text;
	var firstname = text;
	var abbrname = "";
	var pieces;
	var output;
	if (!text.match(/(.*),\s+(.*)/)) {
		text = text.replace(/\.\s*/, ", ");
	}
	if (matches = text.match(/(.*),\s+(.*)/)) {
		lastname = matches[1];
		firstname = matches[2];
		pieces = firstname.split(/\s+/);
		abbrname = "";
		for (var i=0; i<pieces.length; i++) {
			if (pieces[i][0] == pieces[i][0].toLowerCase()) {
				// such as "del"
				abbrname += " " + pieces[i];
			} else if (pieces[i][0] == pieces[i][0].toUpperCase()) {
				abbrname += " " + pieces[i][0] + ".";
			} else {
				// strange case
				abbrname += " " + pieces[i];
			}
		}
		var shortname;
		if (abbrname.length > 0) {
			shortname = lastname + "," + abbrname;
		} else {
			shortname = lastname;
		}
		if (shortname.length > 15) {
			output = "<span style='letter-spacing:-1px; word-spacing:-1px; ";
			output+= "cursor:help' title='" + firstname + " " + lastname +"'>";
			output += shortname + "</a>";
		} else {
			output = "<span style='cursor:help' title='";
			output += firstname + " " + lastname +"'>";
			output += shortname + "</a>";
		}
		return new Handlebars.SafeString(output);
	} else {
		return new Handlebars.SafeString(text);
	}
});



//////////////////////////////
//
// cleantitle Handlebar helper  -- Prevent linebreak after RISM
//      and its number.
//

Handlebars.registerHelper("cleantitle", function(text) {
	return new Handlebars.SafeString(
		text.replace(/RISM /g, "RISM&nbsp;")
	);
});



//////////////////////////////
//
// workletter Handlebar helper -- Add work letter to handlebars helper
//

Handlebars.registerHelper("workletter", function(text) {
	var output = "<a href=/work/?id=" + text;
	output += ">" + text + "</a>";
	return new Handlebars.SafeString(output);
	// return text;
	// text = Handlebars.escapeExpression(text);
	// text = text.replace(/Trm0*/, "");
	// var letter = text.match(/([a-z]+)$/)[1];
	// text = text.replace(/[a-z]+$/, "");
	// var output = text + "<sup>" + letter + "</sup>";
	// return new Handlebars.SafeString(output);
});



//////////////////////////////
//
// sortByText --
//

function sortByText(event, index) {
	var element = event.target;
	while (element && (element.nodeName !== "TABLE")) {
		element = element.parentNode;
	}
	if (!element) {
		returnl;
	}
	var data = element.querySelectorAll(".data");
	var datalist = [];
	var i;
	for (i=0; i<data.length; i++) {
		datalist.push(data[i]);
	}
	datalist.sort(function(a, b) {
		var A = a.cells[index].textContent
		var B = b.cells[index].textContent
		var result = A.localeCompare(B);
		return result;
	});
	var body = element.querySelector("tbody");
	body.innerHTML = "";
	for (i=0; i<datalist.length; i++) {
		body.appendChild(datalist[i]);
	}
}



//////////////////////////////
//
// sortByPublication --
//

function sortByPublication(event, index) {
	var element = event.target;
	while (element && (element.nodeName !== "TABLE")) {
		element = element.parentNode;
	}
	if (!element) {
		returnl;
	}
	var data = element.querySelectorAll(".data");
	var datalist = [];
	var i;
	for (i=0; i<data.length; i++) {
		datalist.push(data[i]);
	}
	datalist.sort(function(a, b) {
		var A = a.cells[index].querySelector(".publication").textContent
		var B = b.cells[index].querySelector(".publication").textContent
		var result = A.localeCompare(B);
		return result;
	});
	var body = element.querySelector("tbody");
	body.innerHTML = "";
	for (i=0; i<datalist.length; i++) {
		body.appendChild(datalist[i]);
	}
}

</script>



