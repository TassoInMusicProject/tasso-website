#!/usr/bin/perl
# Programmer:    Craig Stuart Sapp <craig.stanford.edu>
# Creation Date: Tue Sep 25 07:26:08 PDT 2018
# Last Modified: Tue Sep 25 07:26:11 PDT 2018
# Filename:      makecomposeraton
# Syntax:        perl 5
# vim:           ts=3
#
# Description:   This program downloads the composer index spreadsheet
#                from Google Spreadsheets and creates an ATON file with
#                the same contents.  
#
# Note:          wget must be installed, which is common on linux computers by default.
#                On MacOS computers, install http://brew.sh, and then install with the
#                command "brew wget".

use strict;

# composer spreadsheet:
my $id = "1YcaAQc-mxFFDWyOsT7HOlwZkEqB4rPEuOzXCMTKprMc";
my $gid = "2068334514";
my $url = "https://docs.google.com/spreadsheets/d/$id/export?gid=$gid&format=tsv";
my $contents = `wget -O - "$url"`;
die "Problem downloading data\n" if $contents =~ /^\s*$/;
my @spreadsheet = split(/[\n\r]+/, $contents);
my $linecount = @spreadsheet;
die "Problem downloading data: not enough content.\n" if $linecount < 200;


printHeader();

for (my $i=1; $i<@spreadsheet; $i++) {
	createComposerEntry($spreadsheet[$i]);
}

sub createComposerEntry {
	my ($line) = @_;
	chomp $line;
	my @data = split(/\t/, $line);
	
	# Hardwired indexes, so be careful if spreadsheet columns are rearranged:
	my $Icomposer     = 0;
	my $Ialiases      = 1;
	my $Ihumdrumbirth = 2;
	my $Ihumdrumdeath = 3;
	my $Iprintdates   = 4;
	my $Iarea         = 5;
	my $Inote         = 7;
	my $Iurl          = 8;

	my $composer      = $data[$Icomposer];
	my $aliases       = $data[$Ialiases];
	my $humdrumbirth  = $data[$Ihumdrumbirth];
	my $humdrumdeath  = $data[$Ihumdrumdeath];
	my $printdates    = $data[$Iprintdates];
	my $area          = $data[$Iarea];
	my $note          = $data[$Inote];
	my $url           = $data[$Iurl];

print <<"EOT";
\@\@BEGIN:	COMPOSERDATA
\@COMPOSER:	$composer
\@ALIASES:	$aliases
\@HUMBIRTH:	$humdrumbirth
\@HUMDEATH:	$humdrumdeath
\@DATES:		$printdates
\@AREA:		$area
\@NOTE:		$note
\@COMURL:	$url
\@\@END:		COMPOSERDATA

EOT

}


##############################
##
## printHeader --
##

sub printHeader {

print <<"EOT";
\@\@
\@\@ File: http://www.tassomusic.org/data/indexes/composers.aton
\@\@
\@\@ This file contains a database of composers for the Tasso in Music Project.
\@\@
\@\@ Do not edit this file directly, as it is automatically generated.
\@\@ Make changes to the contents on the spreadsheet:
\@\@    https://docs.google.com/spreadsheets/d/1YcaAQc-mxFFDWyOsT7HOlwZkEqB4rPEuOzXCMTKprMc/edit#gid=2068334514
\@\@ and then type "make composers" in this directory to update this file.
\@\@
\@\@ Meaning of the entries in each record:
\@\@     \@\@BEGIN:	COMPOSERDATA
\@\@     \@COMPOSER:	Name of the composer, in the format "LAST, FIRST".
\@\@     \@ALIASES:	Alternate names or spellings for the composer's name.
\@\@     \@HUMBIRTH:	Birth date of the composer in the Humdrum format.
\@\@     \@HUMDEATH:	Death date of the composer in the Humdrum format.
\@\@     \@DATES:		Birth-Death date of the composer for printing on website.
\@\@     \@AREA:		Locations where the composer was active/lived.
\@\@     \@NOTE:		Note of interest about the composer.
\@\@     \@COMURL:	URL to biography about the composer.
\@\@     \@\@END:		COMPOSERDATA
\@\@


EOT


}



