

<script src="/scripts/scripts-common.js"></script>

<script>
// vim: ts=3

var RWORKLIST;

document.addEventListener("DOMContentLoaded", function() {
	HighlightNavigationBar();

	$("#pitch").focus(function() {
		$(this).data("hasfocus", true);
	});

	$(document.body).keyup(function(event) {
		//if (event.which == EnterKey) {
			if ($("#pitch:focus")) {
				doSearch();
			} else if ($("#interval:focus")) {
				doSearch();
			} else if ($("#rhythm:focus")) {
				doSearch();
			}
		//}
	});

	buildReverseWorklist();
});



//////////////////////////////
//
// doSearch --
// 

function doSearch() {
	var pitch = document.getElementById("pitch");
	var pquery = pitch.value;

	var interval = document.getElementById("interval");
	var iquery = interval.value;

	var rhythm = document.getElementById("rhythm");
	var rquery = rhythm.value;

	if (
			pquery.match(/^\s*$/) &&
			iquery.match(/^\s*$/) &&
			rquery.match(/^\s*$/)
			) {
		var results = document.querySelector("#results");
		var summary = document.querySelector("#summary");
		results.textContent = "";
		summary.textContent = "";
		return;
	}

	var url = "http://josquin.stanford.edu/cgi-bin/tasso?";
	url += "pitch="     + pquery;
	url += "&interval=" + iquery;
	url += "&rhythm="   + rquery;


	var request = new XMLHttpRequest();
	request.onreadystatechange = function() {
		if (request.readyState == XMLHttpRequest.DONE) {
			displayResults(request.responseText);
		} else if (request.status == 400) {
			console.log("THERE WAS AN ERROR IN THE SEARCH");
		} else {
			console.log("STATUS =", request.status);
		}
	};
	request.open("GET", url);
	request.send();
}



//////////////////////////////
//
// displayResults
//

function displayResults(results) {
	var r = JSON.parse(results);
	console.log("R", r);

	var results = document.querySelector("#results");
	var summary = document.querySelector("#summary");

	var stext = "";
	if (r.matchcount == 0) {
		summary.innerHTML = "<span style='color:red;'>no matches</span>";
		results.innerHTML = "";
		return;
	} else {
		stext += r.matchcount;
		if (r.matchcount == 1) {
			stext += " match in "
		} else {
			stext += " matches in "
		}
		stext += r.locations.length;
		if (r.movementcount == 1) {
			stext += " work:";
		} else {
			stext += " works:";
		}
	}
	summary.innerHTML = stext;

	var rtable = "<table>";
	rtable += "<tr>";
	rtable += "<th style='width:70px;'>count</th>";
	rtable += "<th>composer</th>";
	rtable += "<th>work</th>";
	rtable += "</tr>";
	for (var i=0; i<r.locations.length; i++) {
		rtable += displayResultRow(r.locations[i]);
	}
	rtable += "</table>";
	results.innerHTML = rtable;
}


//////////////////////////////
//
// displayResultRow --
//

function displayResultRow(entry) {
	var meta = RWORKLIST[entry.id];
	var title = meta.title;
	var composer = meta.comshort;
	// var url = "http://www.tassomusic.org/work?"
	var url = "/work?"
	var rtext = "<tr>";

	rtext += "<td>";
	rtext += entry.count;
	rtext += "</td>";

	rtext += "<td>";
	rtext += composer;
	rtext += "</td>";

	rtext += "<td>";
	rtext += "<a href='" + url + "id=" + entry.id + "'>" + title + "</a>";
	rtext += "</td>";

	rtext += "</tr>";
	return rtext;
}


//////////////////////////////
//
// buildReveseWorklist --
//

function buildReverseWorklist() {
	WORKLIST = JSON.parse(sessionStorage.WORKLIST);
	RWORKLIST = {};
	var wl = WORKLIST[0].works;
	for (var i in wl) {
		RWORKLIST[wl[i].id] = wl[i];
	}
}




</script>
