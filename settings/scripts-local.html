
<script src="/scripts/scripts-common.js"></script>

{% include_relative listeners.html %}
{% include_relative templates.html %}

<script>
//
// Programmer:    Craig Stuart Sapp <craig@ccrma.stanford.edu>
// Creation Date: Sat Mar 26 07:56:45 PDT 2016
// Last Modified: Tue Mar 28 08:26:04 PDT 2017
// Filename:      settings/scripts-local.html
// Syntax:        JavaScript 1.8/ECMAScript 5
// vim:           ts=3: ft=javascript
//
// Description:   JavaScript management for the musical settings.
//

var CurrentPoem  = 0;  // ID of the current setting
var PoemList     = {}; // List of next/previous settings

var RWORKLIST    = {};  // Reverse work list


//////////////////////////////
//
// displaySource --
//

function displaySource(poem) {
	if (!poem) {
		poem = CurrentPoem;
	}
	if (poem) {
		window.location = "/sources/?id=" + poem;
	} else {
		window.location = "/sources";
	}
}



//////////////////////////////
//
// displayVariant --
//

function displayVariant(poem) {
	if (!poem) {
		poem = CurrentPoem;
	}
	if (poem) {
		window.location = "/variants/?id=" + poem;
	} else {
		window.location = "/variants";
	}
}



//////////////////////////////
//
// displayNextPoem --
//

function displayNextPoem(id) {
	var nid = PoemList[CurrentPoem].next;
console.log("Displaying next setting", id);
	displayMusicalSettings(id);
}



//////////////////////////////
//
// displayPreviousSetting --
//

function displayPreviousSetting() {
	var id = PoemList[CurrentPoem].previous;
console.log("Displaying next setting", id);
	displayMusicalSettings(id);
}



//////////////////////////////
//
// displayMusicalSettings -- Show the literary sources for the given
// 	Rime.
//

function displayMusicalSettings(id, target) {
	if (!target) {
		target = "#contents";
	}

	if (id) {
		id = id.replace(/[a-z]$/, "");
	}

	var element = document.querySelector(target);
	if (!element) {
		console.log("Error: cannot place on page since", target, " doesn't exist.");
		return;
	}

	var counter = 0;
	var maxcount = 5;

	if (sessionStorage.RIMEVERSELIST && 
				(sessionStorage.RIMEVERSELIST != "undefined")) {
		RIMEVERSELIST = JSON.parse(sessionStorage.RIMEVERSELIST);
		counter++;
	}

	if (sessionStorage.RIMESETTINGLIST) {
		RIMESETTINGLIST = JSON.parse(sessionStorage.RIMESETTINGLIST);
		counter++;
	}

	if (sessionStorage.GERUSETTINGLIST) {
		GERUSETTINGLIST = JSON.parse(sessionStorage.GERUSETTINGLIST);
		counter++;
	}

	if (sessionStorage.AMINTASETTINGLIST) {
		AMINTASETTINGLIST = JSON.parse(sessionStorage.AMINTASETTINGLIST);
		counter++;
	}

	if (sessionStorage.WORKLIST) {
		WORKLIST = JSON.parse(sessionStorage.WORKLIST);
		counter++;
	}


	if ((!sessionStorage.RIMEVERSELIST) || 
				(sessionStorage.RIMEVERSELIST === "undefined")) {
		var request = new XMLHttpRequest();
		request.open("GET", "{{site.rime_verses}}");
		request.addEventListener("load", function() {
			var aton = new ATON;
			RIMEVERSELIST = aton.parse(this.responseText).RIME;
			sessionStorage.RIMEVERSELIST = JSON.stringify(RIMEVERSELIST);
			counter++;
			if (counter == maxcount) {
				buildAllSettingList();
				buildPoemList(ALLSETTINGLIST);
				reallyDisplaySettings(id, target);
				counter++;
			}
		});
		request.send();
	}

	if (!sessionStorage.RIMESETTINGLIST) {
		var request = new XMLHttpRequest();
		request.open("GET", "{{site.rime_settings}}");
		request.addEventListener("load", function() {
			var aton = new ATON;
			RIMESETTINGLIST = aton.parse(this.responseText).RIME_SETTING;
			sessionStorage.RIMESETTINGLIST = JSON.stringify(RIMESETTINGLIST);
			counter++;
			if (counter == maxcount) {
				buildAllSettingList();
				buildPoemList(ALLSETTINGLIST);
				reallyDisplaySettings(id, target);
				counter++;
			}
		});
		request.send();
	}

	if (!sessionStorage.GERUSETTINGLIST) {
		var request = new XMLHttpRequest();
		request.open("GET", "{{site.gerusalemme_settings}}");
		request.addEventListener("load", function() {
			var aton = new ATON;
			GERUSETTINGLIST = aton.parse(this.responseText).GERUSALEMME;
			sessionStorage.GERUSETTINGLIST = JSON.stringify(GERUSETTINGLIST);
			counter++;
			if (counter == maxcount) {
				buildAllSettingList();
				buildPoemList(ALLSETTINGLIST);
				reallyDisplaySettings(id, target);
				counter++;
			}
		});
		request.send();
	}

	if (!sessionStorage.AMINTASETTINGLIST) {
		var request = new XMLHttpRequest();
		request.open("GET", "{{site.aminta_settings}}");
		request.addEventListener("load", function() {
			var aton = new ATON;
			AMINTASETTINGLIST = aton.parse(this.responseText).AMINTA;
			sessionStorage.AMINTASETTINGLIST = JSON.stringify(AMINTASETTINGLIST);
			counter++;
			if (counter == maxcount) {
				buildAllSettingList();
				buildPoemList(ALLSETTINGLIST);
				reallyDisplaySettings(id, target);
				counter++;
			}
		});
		request.send();
	}

	if (!sessionStorage.WORKLIST) {
		var request = new XMLHttpRequest();
		request.open("GET", "{{site.worklist}}");
		request.addEventListener("load", function() {
			WORKLIST = JSON.parse(this.responseText);
			sessionStorage.WORKLIST = this.responseText;
			counter++;
			if (counter == maxcount) {
				buildAllSettingList();
				buildPoemList(ALLSETTINGLIST);
				reallyDisplaySettings(id, target);
				counter++;
			}
		});
		request.send();
	}

	if (counter == maxcount) {
		buildAllSettingList();
		buildPoemList(ALLSETTINGLIST);
		reallyDisplaySettings(id, target);
		counter++;
	}
}


//////////////////////////////
//
// buildAllSettingList --
//

function buildAllSettingList() {
	ALLSETTINGLIST = RIMESETTINGLIST.concat(GERUSETTINGLIST).concat(AMINTASETTINGLIST);
}


//////////////////////////////
//
// buildPoemList --
//

function	buildPoemList(list) {
console.log("BUILD POEMLIST", list);
	var tosort = {};
	var id;
	if (!list) {
		list = ALLSETTINGLIST;
	}
	for (var i=0; i<list.length; i++) {
		id = list[i].CATALOGNUM.replace(/[a-z]$/, "");
		tosort[id] = 1;
	}
	var ids = Object.keys(tosort);
	ids.sort();
	PoemList = {};
	for (i=1; i<=ids.length-1; i++) {
		PoemList[ids[i]] = {};
		PoemList[ids[i]].next     = ids[i+1];
		PoemList[ids[i]].previous = ids[i-1];
	}

	if (ids.length == 1) {
		PoemList[ids[0]] = {};
		PoemList[ids[0]].next = ids[0];
		PoemList[ids[0]].previous = ids[0];
		return;
	}

	PoemList[ids[0]] = {};
	PoemList[ids[0]].next = ids[1];
	PoemList[ids[0]].previous = ids[ids.length-1];

	PoemList[ids[ids.length-1]] = {};
	PoemList[ids[ids.length-1]].next = ids[0];
	PoemList[ids[ids.length-1]].previous = ids[ids.length-2];
}




//////////////////////////////
//
// reallyDisplaySettings --
//

function reallyDisplaySettings(id, target) {
console.log("RDS ID = ", id);
	if (!target) {
		target = "#contents";
	}
	var element = document.querySelector(target);
	if (!element) {
		console.log("Error: cannot place literary sources on page.");
		return;
	}
	buildReverseWorklist();

	var output = "";
	if (!id) {
		output += displayMultipleWorks();
	} else {
		output += displaySinglePoem(id);
	}
	element.innerHTML = output;
}



//////////////////////////////
//
// buildReveseWorklist --
//

function buildReverseWorklist() {
	RWORKLIST = {};
	var wl = WORKLIST[0].works;
	for (var i in wl) {
		RWORKLIST[wl[i].id] = 1;
	}
}



//////////////////////////////
//
// displayMultipleWorks --
//

function displayMultipleWorks() {
	var output = "";
	output += "<div style='font-size:100%; margin-left:0px'>";
	output += "<center>";
	output += "<h1 style='margin-top:0; padding-right:50px;'>Musical Settings</h1>";
	output += "</center>";

	var rimelist = RIMEVERSELIST;
	var rime;
	for (var i=0; i<rimelist.length; i++) {
		output += "<center><table style='margin-top:10px; ";
		output += "padding:0; padding-right:50px; width:100%'><tr>";
		output += "<td>";
		output += "</td><td style='width:100%; text-align:center'>";
		output += "<h2>";
		rime = rimelist[i].SOLERTI;
		var entry = rimelist[i];
		if (!entry) {
			console.log("Error accessing rime:", rime);
			console.log("Rime entry:", entry);
			console.log("Rime list:", rimelist);
			return;
		}
		var title = entry.TITLE;
		if (!title) {
			title = entry.RIMETITLE;
		}
		output += title;
		output += "&nbsp;&nbsp;(<i>Rime</i> " + rime + ")</h2>";
		output += "</td><td>";
		output += "</td></tr>";
		output += "</table></center>";

		var table = getMusicalSettingTable(entry);
		output += table;
	}
	output += "</div>\n";
	return output;
}



//////////////////////////////
//
// displaySinglePoem --
//

function displaySinglePoem(id) {
console.log("DISPLAYSINGLEPOEM: ", id);
	var output = "";
//	output += "<div style='font-size:100%; margin-left:50px'>";
//	output += "<center>";
//	output += "<h1 style='padding-right:50px;'>Musical Settings</h1>";
//	output += "</center>";

	var cleanid    = id.replace(/[a-z]$/, "");
	var previousid = PoemList[cleanid].previous;
	var nextid     = PoemList[cleanid].next;
console.log("ID=",cleanid, "NEXT", nextid, "PREV", previousid);

	output += "<center><table style=' width=100%;";
	output += "padding-top:-50px; padding-left:0px; padding-right:0px; width:100%'><tr>";
	output += "<td class='triangle'><span class='triangle' ";
	output += " onclick='displayVariant();'";
	output += "href='/sources?id=";
	output += previousid + "'>";
	output += "<span style='letter-spacing:-7pt;'>";
	output += "&#9664;&#9664;</span></a>";
	output += "</td><td style='width:100%; text-align:center'>";
	output += "<h1 style='margin-top:0;'>Musical Settings</h1>";
	output += "</td><td class='triangle'>";
	output += "<span class='triangle'";
	output += " onclick='displaySource();'";
	output += " href='/sources?id=";
	output +=  nextid + "'>";
	output += "<span style='position:relative;left:-8px; letter-spacing:-7pt;'>";
	output += "&#9654;&#9654;</span></a>";
	output += "</td></tr>";
	output += "</table></center>";

	output += "<center><table style='width=100%; margin-top:-50px; ";
	output += "padding-left:0px; padding-right:0px; width:100%'><tr>";
	output += "<td class='triangle'><span class='triangle' ";
	output += " onclick='displayMusicalSettings(\"" + previousid + "\");'>";
	output += "&#9664;</span>";
	output += "</td><td style='width:100%; text-align:center'>";
	output += "<h2>";
	var entry = GetAllSettingEntry(id, ALLSETTINGLIST);
console.log("ZZZ ENTRY", entry);
	if (!entry) {
		console.log("Error accessing id b:", id);
		console.log("ENTRY:", entry);
		console.log("ALLSETTINGLIST", ALLSETTINGLIST);
		return;
	}
	var title = entry.TITLE;
	if (!title) {
		title = entry.RIMETITLE;
	}
console.log("TITLE", title);
	title = title.replace("ANGIOLETTA", "<span class=name>A<font style=\"font-variant:small-caps\">ngioletta</font></span>");
	title = title.replace("BARBARA", "<span class=name>B<font style=\"font-variant:small-caps\">arbara</font></span>");
	title = title.replace("Angioletta", "<span class=name>A<font style=\"font-variant:small-caps\">ngioletta</font></span>");
	title = title.replace("Barbara", "<span class=name>B<font style=\"font-variant:small-caps\">arbara</font></span>");
	output += title;
	output += getCatalogInfo(id);
	output += "</td><td class='triangle'>";
	output += "<span class='triangle'";
	output += " onclick='displayMusicalSettings(\"" + nextid + "\");'>";
	output += "&#9654;</a>";
	output += "</td></tr>";
	output += "</table></center>";

	var table = getMusicalSettingTable(entry);
	output += table;
	output += "</div>\n";
	return output;

}



//////////////////////////////
//
// getCatalogInfo --
//

function getCatalogInfo(id) {
	var output = "";
	var matches;
	if (matches = id.match(/Trm0*(\d+)/)) {
		output += "&nbsp;&nbsp;(<i>Rime</i> ";
		output += matches[1];
		output += ")</h2>";

	} else if (matches = id.match(/Tsg(\d\d)(\d\d\d)/)) {
		// Tsg99888z :: 99 = canto, 888 = ottava
		var canto = GetRomanNumeral(matches[1]);
		var ottava = matches[2].replace(/^0*/, "");
		output += "&nbsp;&nbsp;(<i>Gerusalemme</i> ";
		output += canto + "/" + ottava;
		output += ")</h2>";

	} else if (matches = id.match(/Tam(\d)(\d\d)(\d\d\d\d)/)) {
		// Tam9887777z :: 9 = Act, 88 = scene, 7777 = verse
		var act = GetRomanNumeral(matches[1]);
		var scene = matches[2].replace(/^0*/, "");
		var verse = matches[3].replace(/^0*/, "");
		output += "&nbsp;&nbsp;(<i>Aminta</i> ";
		output += act + "/" + scene + "/" + verse;
		output += ")</h2>";

	} else {
		output = "ERROR";
	}
	return output;

}



//////////////////////////////
//
// buildSetList --
//

function buildSetList(entry) {
console.log("GOT HERE AAA", entry);
	var id = entry.CATALOGNUM;
console.log("ID=", id);
	var cleanid = id.replace(/[a-z]$/, "");
	if (!cleanid) {
		return;
	}
console.log("cleanid", cleanid);
	var WORKS = [];
	var WLIST = ALLSETTINGLIST;
	for (var i=0; i<WLIST.length; i++) {
		if (WLIST[i].CATALOGNUM.match(cleanid)) {
			WORKS.push(WLIST[i]);
		}
	}
	WORKS.sort(function (a, b) {
		if (a.CATALOGNUM < b.CATALOGNUM) {
			return -1;
		} else if (a.CATALOGNUM > b.CATALOGNUM) {
			return +1;
		}
		return 0;
	});
	entry.WORKS = WORKS;
}



//////////////////////////////
//
// getMusicalSettingTable --
//

function getMusicalSettingTable(entry) {
console.log("GMS ENTRY", entry);
	if (!entry) {
		return ""
	}
	if (!entry.WORKS) {
		buildSetList(entry);
	}
	var tsource = document.querySelector("#settings-template")
	                      .textContent;
	var settingTemplate = Handlebars.compile(tsource);
console.log("WORKS", entry.WORKS);
	var output = settingTemplate(entry);
	return output;
}

</script>
